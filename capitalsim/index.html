<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>a website: capitalism</title>
<!--<link href="../default.css" rel="stylesheet" type="text/css">-->
<!--
nooooooo don't look at my messy js code! you can't do that!!!!!!!!!!!!

here's the todo, in the form of a tangible list:
1 d make a move from these clunky BigInts to something much faster (expanding on the idea of a double, mayhaps?), and thus granting much better framerates for 1e+4000 and potentially beyond
2 - add a horizontal scrollbar to the building table, allowing for arbitrarily many planets.
3 d only display the money type corresponding to where the mouse is (or something along those lines; make the currency display more compact and less redundant)
4 - add a dedicated system for angel upgrades
5 d saving!
6 d add a <select> option in the top right of the Upgrades box that allows the number of displayed upgrades to be changed (maybe something like 1, 4, 8, 12, 16?)
7 d make the settings box retractable/toggleable
8 - only update the progress bars if they are visible. (improve preformance on progress bars in general)
9 d include upgrade/tier boosts in the get_profit method (alternatively, expand into a recalculate profit method kindof like recalculate prices?) done in spirit; upgrades now only fire when they need to
10 d add a system for saving and loading from and to a file
11 d add text announcements that say how long you were gone, or when the game autosaves. also for when an update occurs!
12 d base64 encoding for savedata, and decoding ofcourse when loading.
13 - move class attribute changes to classList.add / classList.remove, as they have automated tools for determining whether or not a class is already applied. (it'll make the code cleaner)

-->
<style>
body
{
	background-color: #000000;
	generic-family: serif;
	font-family: "Garamond", Garamond, serif;
	font-weight: lighter;
	text-align: justify;
	color: #ffffff;
}
hr
{
	background-color: #00ff00;
	height:1px;
	border-width:0;
}
h1
{
	color: #00ff00;
}
.button
{
	background-color: #000000;
	display: inline-block;
	font-family: Consolas,"courier new";
	line-height: 112%; /* general rule of thumb, what with all the tall moon symbols */
	border: 1.6px outset;
}
.button-enabled:active {border:1.6px inset;}
.button-enabled{color:#ffffff;cursor:pointer;animation-name:button-e;animation-duration:0.2s;}
.button-enabled:hover{background-color:#111111;}
.button-disabled{color:#aaaaaa;cursor:default;animation-name:button-d;animation-duration:0.2s;}/*background-color:#1a1a1a;}*/
/*.button-disabled:hover{background-color:#222222;}*/
@keyframes button-e {from {color:#aaaaaa} to {color:#ffffff}}
@keyframes button-d {from {color:#ffffff} to {color:#aaaaaa}}
.title
{
	color:#aaaaaa;
	display:inline;
}
.important-text
{
	animation-name: notify;
	animation-duration: 1s;
	animation-iteration-count: infinite;
}
@keyframes notify {from {color:#ffff00} to {color:#00ff00}}
.svgtext
{
	font-family:initial;
	text-align:center;
	text-anchor:middle;
	text-shadow:2px 2px black;
}
.price-cantafford {color:#cd2512;font-size:16px;font-family:initial;display:inline;animation-name:cantafford;animation-duration:0.2s;line-height:110%;}
.price-canafford {color:#25cd12;font-size:16px;font-family:initial;display:inline;animation-name:canafford;animation-duration:0.2s;line-height:110%;}
.noselect {user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;-moz-user-select:none;-ms-user-select:none;}
@keyframes canafford {from {color: #cd2512;} to {color: #25cd12;}}
@keyframes cantafford {from {color: #25cd12;} to {color: #cd2512;}}
.building
{
	border:1px solid #999999;
	padding:10px;
	margin:0px 16px 16px 0px;
	max-width:400px;
}
table, th, tr {font-family:inherit;font-weight:inherit;}
.td-building {padding:0}
.upgrades
{
	border:1px solid gold;
	padding:10px;
	margin:0px 16px 16px 0px;
}
.angels
{
	border:1px solid white;
	padding:10px;
	margin:0px 16px 16px 0px;
}
details > .tier-summary {
	padding: 4px;
	width: 200px;
	background-color: #333333;
	border: none;
	box-shadow: 1px 1px 2px #888888;
	cursor: pointer;
	font-family: initial;
	color: #a1ea1e;
	font-size: 14px;
}
details > .tier-desc {
	background-color: #333333;
	padding: 4px;
	margin: 0;
	box-shadow: 1px 1px 2px #888888;
	color: #eeeeee;
	font-size: 14px;
}
label, select {color:#ffffff;font-family:initial;}
.hidden {display:none;}
.fps {
	position:fixed;
	bottom:0;
	right:0;
	width:300px;
	border:1px solid white;
	padding:1px;
	font-family:initial;
	background-color:black;
}
.announcements {
	position:fixed;
	bottom:24px;
	right:24px;
	width:64px;
	height:64px;
	border:1px solid #dddddd;
	padding:4px;
	font-family:initial;
	background-color:rgba(0,0,0,0.65);
	/*overflow:hidden;*/
	word-spacing:0px;
	overflow-x:hidden;
	overflow-y:hidden;
	text-align:left;
	border-radius:5px;
	opacity:0.3;
	animation-name: hide-announcements;
	animation-duration: 5s;
	animation-delay: 0s;
	/*animation-fill-mode: backwards;*/
}
.announcements > div {
	opacity:0;
	animation-name: hide-announcement-divs;
	animation-duration: 5s;
	animation-delay: 0s;
	/*animation-fill-mode: backwards;*/
}
@keyframes hide-announcements {
	0% {width:350px;height:100px;opacity:1;}
	60% {width:350px;height:100px;opacity:1;} /* maybe someday i'll find a more satisfying way of doing all of this */
	100% {width:64px;height:64px;opacity:0.3;} /* or not! who knows! */
}
@keyframes hide-announcement-divs {
	0% {opacity:1;}
	60% {opacity:1;}
	100% {opacity:0;}
}
.announcements:hover {
	width:350px;
	height:100px;
	opacity:1;
	overflow-y:auto;
	animation-name: show-announcements !important;
	animation-duration: 1s;
	animation-delay: -1s; /* gah */
	animation-fill-mode: forwards;
}
.announcements:hover > div {
	opacity:1;
	animation-name: show-announcement-divs !important;
	animation-duration: 1s;
	animation-delay: -1s; /* how do i get rid of flickering without getting rid of the cool effect :( */
	animation-fill-mode: forwards;
}
@keyframes show-announcements {
	0% {width:64px;height:64px;opacity:0.3;}
	100% {width:350px;height:100px;opacity:1;}
}
@keyframes show-announcement-divs {
	to {opacity:1;}
	from {opacity:0;}
}
.world-currency {
	padding:4px;
	/*border:1px solid #00ff00;*/
	position:absolute;
	top:0px;
	margin:0px 16px 16px 0px;
	width:100%;
	background-color:rgba(0,0,0,0.65);
	text-shadow:2px 2px black;
	/*color:#00ff00;*/
	line-height:120%;
}
.settings-title-tooltip {
	font-size:70%;
	color:#555555;
	display:inline;
	vertical-align:center;
	display:none;
}
.settings-title:hover .settings-title-tooltip {
	/*display:inline;*/
	display:none;
}
</style>
</head>
<body>
<center><h1>Capitalsim <div id="version" style="display:inline;font-size:65%;">v.1</div></h1></center>
<hr>
<div id="settings" style="position:absolute;right:16px;border:4px solid #ffffff;color:#ffffff;width:440px;font-family:initial;padding:4px;background-color:#000000;text-align:left;">
	<details>
	<summary class="noselect settings-title" style="cursor:pointer;padding-left:3px;"><div style="text-align:center;position:absolute;display:inline;width:100%;left:0px;">settings<div class="settings-title-tooltip"> (click to open)</div><div class="settings-title-tooltip"> (click to close)</div></div></summary>
	<br>
	<!--<label for="save_button">save: </label>-->
	<button name="save_button" id="save_button" class="button button-enabled noselect" onclick="save_to_localStorage()">Save Game</button>
	<small style="color:#aaaaaa;">&emsp;(game autosaves every 60 seconds)</small>
	<br>
	
	<button name="export_button" id="export_button" class="button button-enabled noselect" style="margin-right:10px;" onclick="save_to_export()">Export Game</button>
	<button name="import_button" id="import_button" class="button button-enabled noselect" onclick="load_from_import()">Import Game</button>
	<small style="color:#aaaaaa;">&emsp;(saving/loading using the raw savedata. good for transfers)</small>
	<!--<br>-->
	
	<textarea disabled class="hidden" id="import_export_window" style="width:80%;height:80pt;border:1px solid #555555;color:#aaffaa;font-family:monospace;padding:4px;margin:2px;overflow-y:auto;resize:none;background-color: #000000;cursor:auto;"></textarea>
	<div id="import_export_info" style="display:inline;"></div>
	<button id="confirm_import_button" onclick="confirm_import();" class="button button-enabled noselect hidden">Import</button>
	<br>
	
	<button name="save_to_file_button" id="save_to_file_button" class="button button-enabled noselect" style="margin-right:10px;" onclick="save_to_file()">Export to File</button>
	<button name="load_from_file_button" id="load_from_file_button" class="button button-enabled noselect" style="position:relative;"><input type="file" onchange="load_from_file(event)" style="left:0px;top:0px;width:100%;height:100%;opacity:0;position:absolute;cursor:pointer;">Import from File</button>
	<small style="color:#aaaaaa;">&emsp;(good for keeping backups on your computer)</small>
	<br>
	<br>
	<br>
	<label for="formatting_mode">number formatting: </label>
	<select name="formatting_mode" id="formatting_mode" class="button">
		<option value="0">long (million, billion, etc.)</option>
		<option value="1">short (M, B, T, Qa, Qi, etc.)</option>
		<option value="2">none (1.234e+99 etc.)</option>
	</select>
	<br>
	<label for="currency_transition_speed">currency transition speed: </label>
	<input type="range" id="currency_transition_speed" name="currency_transition_speed" min="1.05" max="3" value="1.3" step="0.05" style="vertical-align:middle"><div style="display:inline;" id="displayed_transition_speed">1.3</div>
	
	</details>
</div>

<div id="currencies" style="width:38%;height:48px;margin:0px 16px 16px 0px;position:sticky;position:-webkit-sticky;top:4px;">

<!-- top:4px; -->
	<h1 id="dollars" style="border:1px solid #00ff00;top:0px;color:#00ff00;">$0.00</h1>

<!-- top:68px; -->
	<h1 id="moon_credits" style="border:1px solid #0054ff;top:0px;color:#0054ff;" class="hidden">0.00</h1>

<!-- top:132px; -->
	<h1 id="mars_dollars" style="border:1px solid #cf3000;top:0px;color:#cf3000;" class="hidden">0.00</h1>
	
<!-- cunga-bdoa -->
	<h1 id="termins" style="border:1px solid #ff00ff;top:0px;color:#ff00ff;" class="hidden">0.00</h1>
	
</div>

<table id="buildings" style="width:100%;padding:0;border-collapse:collapse;border-spacing:0;">
	<tr>
		<th style="width:440px;"></th>
		<th style="width:440px;"></th>
		<th style="width:440px;"></th>
		<th></th>
	</tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<!-- expensive ones -->
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
	<tr></tr>
</table>
<!--<div id="earth-buildings"></div>
<div id="moon-buildings"></div>-->
<div id="upgrades" class="upgrades" onmouseenter="focus_currency(GUI_displayed_upgrades)">
	<h2 id="upgrades_title" class="title">Upgrades</h2><br>
	<label for="upgrades_world_selector" id="upgrades_world_selector_label" class="hidden">for world: </label>
	<select name="upgrades_world_selector" id="upgrades_world_selector" class="button hidden">
	</select>
	
	<div style="float:right;display:inline;">
	<label for="upgrades_amount_displayed" id="upgrades_amount_displayed_label">number of upgrades to show: </label>
	<select name="upgrades_amount_displayed" id="upgrades_amount_displayed" class="button">
		<option value="8">8</option>
		<option value="1">1</option>
		<option value="4">4</option>
		<option value="12">12</option>
		<option value="16">16</option>
		<option value="32">32</option>
		<option value="64">64</option>
	</select>
	</div>
	
	<br>
	<table id="upgrades_table" style="width:100%;padding:0;border-collapse:collapse;border-spacing:0;">
		<tr>
			<th style="width:25%"></th>
			<th style="width:25%"></th>
			<th style="width:25%"></th>
			<th style="width:25%"></th>
		</tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
		<tr></tr>
	</table>
</div>
<div id="angels" class="angels hidden" onmouseenter="focus_currency(GUI_displayed_angels)">
	<h2 id="angels_title" class="title">Angel Investors</h2><br>
	<label for="angels_world_selector" id="angels_world_selector_label" class="hidden">for world: </label>
	<select name="angels_world_selector" id="angels_world_selector" class="button hidden">
	</select><br>
	
	<div style="font-family:initial;font-size:1.5em;text-align:center;color:#ffff00">You currently have <div id="angel_amount" style="display:inline;color:#ff00ff;">0 angels</div> providing a <div id="boost_per_angel" style="display:inline;color:#ff00ff;">1%</div> boost each, resulting in a total multiplier of <div id="total_angel_boost" style="display:inline;color:#ff00ff;">x1.00</div></div>
	
	<div style="font-family:initial;font-size:2em;text-align:center;" id="claimable_angels">Restarting now would give you: 0 angels</div>
	<div style="font-family:initial;text-align:center;" id="cost_of_next_angel">You need $1 trillion to get to the next angel.</div>
	<center><button id="angel_restart_button" class="button noselect button-disabled" disabled>Restart for 0 angels</button></center>
	<div style="font-family:initial;"><i>holy</i> smokes! look at those profits!</div>
</div>
<div id="fps" class="fps"><small>this is an fps counter. i have it disabled for now :)</small></div>
<div id="announcements" class="announcements"></div>
<script src="decimal.js"></script>
<script>
//let t = new Date();
function get_element(e) { // somehow this came after the angel button event listener and still worked
	return document.getElementById(e);
}
let absolute_limit = Decimal("1e+9000000000000000"); // i will have no more of this
let cuberoot_threshold = Decimal(Number.MAX_VALUE); // ridiculous folly
let zero =()=> {return new Decimal('0');}
let game_version = 1;
let savefile_version = 0;
let game_updated =()=> {return savefile_version < game_version;}
get_element("version").innerHTML = "v."+game_version;
//let t2 = new Date();
//let dt = t2.getTime() - t.getTime();
//console.log(dt);
// according to those lovely commented-out code-snippets, the calculation of that large number (10n**4002n) takes no time at all. strange!
/*function newton_cuberoot(n) { // oh my goodness gracious this actually works
	if (n < cuberoot_threshold) return BigInt(Math.floor(Math.pow(Number(n),1/3)+1e-9)); // this is just way too imprecise for small values, no idea why. a small value epsilon (1e-9) must be added in order for floor to not round 5.999999999999 (which is 6) down to 5.
	let mag_n = (n+'').length;
	let precision_threshold = 10n**BigInt(Math.round(mag_n/4));
	let x = 10n**BigInt(Math.floor(mag_n/3));
	/*if (n < 1000000000000000n) { // we only need a head start and a large margin for error once the numbers get large
		precision_threshold = 1n;
	}*
	let x_old = x;
	let step = 0n;
	let P =(x)=> {return (x**3n)-n}
	let dP =(x)=> {return 3n*(x**2n)}
	let abs =(x)=> {return (x>0) ? x : -x;}
	for (let i = 0; i < 40; i++) {
		step = -(P(x) / dP(x));
		x_old = x;
		x += step;
		if (abs(x - x_old) < precision_threshold) break;
	}
	return x;
}cbrt=(n)=>{return newton_cuberoot(n);}
function bin_cuberoot(n) {
	let mag_n = (n+'').length-1;
	let precision_threshold = 10n**BigInt(Math.round(mag_n/4));
	if (n < 1000000000000000n) precision_threshold = 1n;
	let min = 10n**BigInt(Math.floor(mag_n/3));
	let max = 100n*min;
	let mid = 0n;
	while (max-min > precision_threshold) {
		mid = (min+max)>>1n;
		if (mid**3n < n) {
			min = mid + 1n;
		} else {
			max = mid;
		}
	}
	return mid;
}*/
function fastpow(n, exponent) {
	if (!Number.isSafeInteger(exponent)) return Decimal(1).div(0);
	if (!Decimal.isDecimal(n)) n = Decimal(n);
	let blocks = [n];
	let bits = Math.ceil(Math.log2(exponent));//exponent.toString(2).length; // what?????????
	for (let i = 1; i < bits; i++) {
		blocks.push(blocks[i-1].times(blocks[i-1]));
	}
	let answer = Decimal(1);
	for (let i = 0; i < bits; i++) {
		if (Math.floor(exponent / (1<<i)) & 1 == 1) {
			answer = answer.times(blocks[i]);
		}
	}
	return answer;
}//console.log(fastpow(Decimal(1.15), P).toString() + "; " + Decimal(1.15).pow(P).toString()); P*=10 
class currency {
	constructor(name, display_name, symbol) {
		this.name = name;
		this.display_name = display_name;
		this.symbol = symbol;
		// maybe desc later?
		
		this.amount = zero();
		this.total = zero();
		this.all_time = zero();
	}
	earn(earning) {
		this.amount = this.amount.plus(earning);
		this.total = this.total.plus(earning);
		this.all_time = this.all_time.plus(earning);
	}
	spend(expenditure) {
		this.amount = this.amount.sub(expenditure);
	}
	tick() {
		if (this.amount.gt(absolute_limit)) {
			this.amount = absolute_limit;
			this.total = absolute_limit;
			this.all_time = absolute_limit;
		}
	}
	get_amount() {return this.amount;}
	get_total() {return this.total;}
	get_all_time() {return this.all_time;}
	get_save_data() {
		let string = "";
		string += this.amount + ",";
		string += this.total + ",";
		string += this.all_time;
		return string;
	}
	set_from_save_data(string) {
		let data = string.split(",");
		this.amount = Decimal(data[0]);
		this.total = Decimal(data[1]);
		this.all_time = Decimal(data[2]);
	}
}
let worlds = [];
class world {
	constructor(name, display_name, currency, angel_investors, requirement_met, requirement_text, requirement_price, requirement_discovery, progress_bg_color, progress_bar_color, currency_color, unlocked=false) {
		let id = worlds.length; // for later reference
		this.id = id;
		this.name = name;
		this.display_name = display_name;
		this.currency = currency;
		this.angel_investors = angel_investors;
		this.angel_cost = Decimal('1e+12');
		this.claimable_angels = zero();
		this.cost_of_next_angel = zero();
		this.boost_per_angel = Decimal('0.01');
		this.total_angel_boost = zero();
		this.buildings = [];
		this.upgrades = [];
		this.unlocked = unlocked;
		this.requirement_met = requirement_met; //             (e.g. dollars >= (100n * 10n**12n). used for checking if the button should be highlighted and if the purchase should go through.)
		this.requirement_text = requirement_text; //           (e.g. "Unlock for $1 trillion". text for the button. (this is actually code which returns a text object; that numerical value needs to be formatted correctly.))
		this.requirement_price = requirement_price; //         (e.g. dollars.spend(100n * 10n**12n). code to execute when the supposedly checked-for price has been accepted. this should just be code to pay that promised price.)
		this.requirement_discovery = requirement_discovery; // (e.g. return moon.unlocked;. criterion/a for unhiding the unlock button.)
		//this.on_unlock = on_unlock;
		this.progress_bg_color = progress_bg_color;
		this.progress_bar_color = progress_bar_color;
		this.currency_color = currency_color;
		
		/* * * redundancies * * */
		this.calculated_building_profits = [];
		this.calculated_building_speeds = [];
		
		worlds.push(this);
		
		// add this planet to the selectors
		let upgrades_gui_option = document.createElement("option");
		upgrades_gui_option.setAttribute("value", id);
		upgrades_gui_option.setAttribute("id", "upgrades_option_"+id);
		upgrades_gui_option.setAttribute("class", "hidden");
		upgrades_gui_option.innerHTML = display_name;
		get_element("upgrades_world_selector").appendChild(upgrades_gui_option);
		let angels_gui_option = document.createElement("option");
		angels_gui_option.setAttribute("value", id);
		angels_gui_option.setAttribute("id", "angels_option_"+id);
		angels_gui_option.setAttribute("class", "hidden");
		angels_gui_option.innerHTML = display_name;
		get_element("angels_world_selector").appendChild(angels_gui_option);
		
		let world_unlock_button = document.createElement("button");
		world_unlock_button.setAttribute("class", "button noselect button-disabled");
		world_unlock_button.setAttribute("style", "line-height:110%;");
		world_unlock_button.setAttribute("id", name+"_unlock_button");
		world_unlock_button.setAttribute("onclick", name+".unlock();");
		world_unlock_button.setAttribute("disabled", true);
		//world_unlock_button.innerHTML = requirement_text(); <- gonna have to wait on this
		
		get_element("buildings").children[0].children[0].children[id].appendChild(world_unlock_button);
	}
	calculate_claimable_angels() {
		if (this.currency.get_total() < this.angel_cost) return zero();
		this.claimable_angels = Decimal.cbrt(this.currency.get_all_time().div(this.angel_cost)).minus(this.angel_investors.get_amount()).floor();
	}
	calculate_cost_of_next_angel() {
		let K = this.claimable_angels.plus(this.angel_investors.get_amount()); // all the angesl :)
		this.cost_of_next_angel = this.angel_cost.times((K.plus('1')).pow('3'));
	}
	calculate_total_angel_boost() {
		let boost_of_all_angels = this.boost_per_angel.times(this.angel_investors.get_amount());
		this.total_angel_boost = boost_of_all_angels.plus(1); // boost here is being measured as a multiplier, so we add 1
	}
	restart() {
		this.calculate_claimable_angels(); // no tomfoolery!
		this.angel_investors.earn(this.claimable_angels);
		for (let i = 0; i < this.upgrades.length; i++) this.upgrades[i].on_reset();
		for (let i = 0; i < this.buildings.length; i++)this.buildings[i].on_reset();
		this.currency.amount = zero();
		this.currency.total = zero();
		this.boost_per_angel = Decimal(0.01);
		refresh_upgrade_buttons(true, this, true); // so truuue
		this.claimable_angels = zero(); // for some reason you absolutely need this; the update to get this number right gets delayed somehow. investigate later.
	}
	unhide_option_in_selectors() {
		get_element("upgrades_option_"+this.id).className = "";
		get_element("angels_option_"+this.id).className = "";
	}
	unlock() {
		if (this.requirement_met()) { // just so we're clear
			this.requirement_price(); // pay it /* <del>payments now only accepted in this.on_unlock(). thank you for your patronage.</del> */
			for (let i = 0; i < this.upgrades.length; i++) this.upgrades[i].on_unlock(); // idk why you'd wanna do this but uh go ahead i guess
			for (let i = 0; i < this.buildings.length;i++) this.buildings[i].on_unlock();
			//this.on_unlock(); // tell me why all this stuff is so fractured please i must know
			this.unhide_option_in_selectors();
			this.unlocked = true;
		}
	}
	get_save_data() {
		let string = this.id + ";";
		string += this.currency.get_save_data() + ";";
		string += this.angel_investors.get_save_data() + ";";
		for (let i = 0; i < this.buildings.length; i++) {
			string += this.buildings[i].get_save_data() + (i != this.buildings.length-1 ? "^" : "");
		}
		string += ";";
		for (let i = 0; i < this.upgrades.length; i++) {
			string += this.upgrades[i].get_save_data();
		}
		string += ";";
		string += this.unlocked ? "1" : "0";
		return string;
	}
	set_from_save_data(string) {
		let data = string.split(";");
		if (data[0] != this.id+'') throw 'this world is not loading its corresponding data';
		this.currency.set_from_save_data(data[1]);
		this.angel_investors.set_from_save_data(data[2]);
		let building_data = data[3].split("^");
		for (let i = 0; i < building_data.length; i++) {
			this.buildings[i].set_from_save_data(building_data[i]);
		}
		let upgrade_data = data[4];
		for (let i = 0; i < upgrade_data.length; i++) {
			this.upgrades[i].set_from_save_data(upgrade_data[i]);
		}
		this.unlocked = (data[5] == "1");
	}
}
get_element("angel_restart_button").addEventListener("click", ()=>{
	let world_name = get_element("angels_world_selector").value;
	eval(world_name+".restart()");
});
let angel_symbol = "A";

let dollars = new currency("dollars", "dollar", "$");
let earth_angels = new currency("earth_angels", "angel", angel_symbol);

let moon_symbol = String.fromCharCode(9789);
let moon_credits = new currency("moon_credits", "moon credit", moon_symbol);
let moon_angels = new currency("moon_angels", "moon angel", moon_symbol + angel_symbol);

let mars_symbol = String.fromCharCode(8380);
let mars_dollars = new currency("mars_dollars", "mars dollar", mars_symbol);
let mars_angels = new currency("mars_angels", "mars angel", mars_symbol + angel_symbol);

let termins = new currency("termins", "termin", String.fromCharCode(10810)); // singular: Termin (mercury?)
let eternity_points = 0n; // megabucks i guess
//String.fromCharCode(1000); weird backwards s
//String.fromCharCode(10000); pencil
//String.fromCharCode(3497); mogus
//String.fromCharCode(0x237c); unknown
//String.fromCharCode(999); squiggly line thing ("s"?)
sesame=(c=dollars)=>{c.earn(absolute_limit);}
sall =()=> {for (let i = 0; i < worlds.length; i++) {worlds[i].currency.earn(absolute_limit);}}

let earth = new world("earth", "Earth", dollars, earth_angels, requirement_met=()=>{return true;}, requirement_text=()=>{return "";}, requirement_price=()=>{}, requirement_discovery=()=>{return false;}, "#002800", "#009600", "#00ff00", true); // you can't discover earth, buddy
// on_unlock=()=>{}
earth.unhide_option_in_selectors(); // it just makes sense to do
let moon_price = Decimal('1e+12');
let moon = new world("moon", "The Moon", moon_credits, moon_angels, requirement_met=()=>{return dollars.get_amount().gt(moon_price);}, requirement_text=()=>{return "Go to the moon for "+money(moon_price, "$")+".";}, requirement_price=()=>{dollars.spend(moon_price);}, requirement_discovery=()=>{return dollars.get_total().gt(moon_price.div(100));}, "#002811", "#009949", "#0054ff");
// on_unlock=()=>{moon_shoes.starting_freebies=1;moon_shoes.freebies=1;}
let mars_price = Decimal('1e+33');
let mars = new world("mars", "Mars", mars_dollars, mars_angels, requirement_met=()=>{return moon_credits.get_amount().gt(mars_price);}, requirement_text=()=>{return "Go to mars for "+money(mars_price, moon_symbol)+".";}, requirement_price=()=>{moon_credits.spend(mars_price);}, requirement_discovery=()=>{return moon.unlocked;}, "#300005", "#800000", "#cf3000");
// on_unlock=()=>{potato_stand.starting_freebies=1; potato_stand.freebies=1;}

//let dollars = 0n;
let money_display_threshold = Decimal('1000000'); // 1 million

let irregulars_long = ["thousand","million","billion","trillion","quadrillion","quintillion","sextillion","septillion","octillion","nonillion"];
let prefixes_long = ["","un","duo","tre","quattuor","quin","sex","septen","octo","novem"];
let infixes_long = ["","de","vi","tri","quadra","quinqua","sexa","septua","octa","nona"];
let suffixes_long = ["c","gint","cent","ducent","trecent","quadringent","quingent","sescent","septingent","octingent","nongent","mill","centimill","ducentimill","trecentimill","quadringmill"];

let irregulars_short = ["","M","B","T","Qa","Qi","Sx","Sp","Oc","No"];
let prefixes_short = ["","Un","Do","Tr","Qa","Qi","Sx","Sp","Oc","No"];
let infixes_short = ["","D","V","T","Qa","Qi","Sx","Sp","O","N"];
let suffixes_short = ["c","g","Cn","Dcn","Tcn","Qan","Qin","Scn","Spn","Ocn","Non","Ml","CMl","DMl","TMl","QaMl"];

let irregulars_silly = ["","sillion","zillion","rillion","yillion","pillion","lillion","willion","jillion","gillion"];
let prefixes_silly = ["","silly","zilly","really","yelly","pilly","lily","wily","jilly","gilly"];
let infixes_silly = ["","sa","zilli","realli","yeli","pilli","lili","wheeli","jelli","gili"];
let suffixes_silly = ["z","zilliz","bigjav","biggerjav","biggijav","yiljav","piljav","lijav","willajav","jillijavaj","gilliv","gakyak","wawas","kryll","tawas","vrill"];

function formatting(irregulars, prefixes, infixes, suffixes, illion="illion", spacing=" ") {
	return function (input, prefix="$", decimals=2) { // decimals controls how many of the digits (starting on the right) do we treat as being after a decimal point.
		let n = Decimal(input);
		if (!n.isFinite()) return prefix + "Infinity";
		if (n.lt(money_display_threshold)) {
			let string = "";
			let chars = n.toFixed(decimals).split("").reverse();
			let point_shift = decimals > 0 ? 1 : 0; // move over!!
			for (let i = 0; i < chars.length; i++)
			{
				if (i%3 == (0+decimals+point_shift)%3 && i > 0+decimals+point_shift) string = "," + string;
				string = chars[i] + string;
			}
			string = prefix + string;
			return string;
		}
		
		let magnitude = n.e;
		let illionth = Math.floor((magnitude-3)/3); // illions start at 6
		let significand = Decimal(n); // a new decimal of value n
		significand.e -= 3 * (illionth + 1);
		
		let chars = significand.toFixed(3,3).replaceAll('.','').split("").reverse();
		let string = "";
		let cutoff_point = 0;
		for (let i = 0; i < chars.length; i++) {
			if (chars[i] == '0' && cutoff_point == i && i<3) {
				cutoff_point++;
			} else {
				if (i == 3 && string.length > 0 && cutoff_point != 3) string = "." + string;
				string = chars[i] + string;
			}
		} // gah
		
		let ending = illion;
		if (illionth <= 9) string = string + spacing + irregulars[illionth];
		if (illionth >= 10 && Math.floor(illionth/100)+1 < suffixes.length) {
			digits = (illionth + "").split("").reverse();
			if (illionth >= 10 && illionth < 20) ending = suffixes[0] + ending;
			if (illionth >= 20 && illionth < 100) ending = suffixes[1] + ending;
			if (illionth >= 100) ending = suffixes[Math.floor(illionth/100)+1] + ending;
			string = string + spacing + prefixes[digits[0]] + infixes[digits[1]] + ending;
		}
		if (Math.floor(illionth/100)+1 >= suffixes.length) { // in case all else fails (probably shouldn't come to this/be used)
			let ord_indicators = ["th","st","nd","rd","th","th","th","th","th","th"];
			let ord_indicator = (illionth < 10**6 ? ord_indicators[Number(((illionth+'').split("").reverse())[0])] : 'th');
			return prefix + string + " " + beautify(illionth) + ord_indicator + "&ndash;illion";
		}
		return prefix + string;
	}
}
function raw_formatting(input, prefix="$", decimals=2) {
	let n = Decimal(input);
	if (!n.isFinite()) return prefix + "Infinity";
	if (n.lt(money_display_threshold)) return formattings[0](n, prefix, decimals);
	let str = n.toPrecision(4);
	let significand = str.substr(0,5);
	let backwards = significand.split('').reverse();
	for (let i = 0; i < backwards.length; i++) { // get rid of extraneous zeroes, and if we get all of them (i.e., our formatted string is small enough when we hit the dot) then just add the last digit and break.
		if (backwards[i] != "0" && backwards[i] != ".") {significand = str.substr(0, backwards.length - i); break;}
	
		//if (str[i] == "." && formatted.length < (n.e+'').length + 3) {formatted = str[str.length-1] + formatted; break;}
		//if (str[i] != "0" || i < str.indexOf("e")) formatted = str[i] + formatted;
	}
	return prefix + significand + "e" + (n.e>=0?'+':'-') + raw_formatting(n.e,'',0);
	//catch {return "NaN";} // tehe
}
formattings = [
	formatting(irregulars_long, prefixes_long, infixes_long, suffixes_long),
	formatting(irregulars_short, prefixes_short, infixes_short, suffixes_short, "", ""),
	raw_formatting,
	formatting(irregulars_silly, prefixes_silly, infixes_silly, suffixes_silly),
	f=()=>{return "test";}
];
let formatting_mode = 0;
let money =(n, prefix="$", decimals=2)=> {return formattings[formatting_mode](n,prefix,decimals);} // display as money >:]
let beautify =(n)=> {return money(n, "", 0);} // works just like in cookie clicker but a billion times as convoluted

let temporal_suffixes = ["s","ms","&mu;s","ns","ps","fs","as","zs","ys"];
function as_time(time, do_ms=false) {
	t=Decimal(time);
	if (t.gte(0.001)) {
		let ms = t.times(1000).mod(1000).round();
		let s = t.floor();
		let m = s.div(60).floor();
		let h = m.div(60).floor();
		s=s.mod(60);
		m=m.mod(60);
		try {
			return ("0".repeat(Math.max(0,2-(h+'').length))) + h + ":" + ("0".repeat(2-(m+'').length)) + m + ":" + ("0".repeat(2-(s+'').length)) + s + ("." + ("0".repeat(Math.max(0,3-(ms+'').length))) + ms).repeat(do_ms ? 1 : 0);
		} catch {
			return "t was nan";
		}
	}
	//let t_as_string = t.toExponential();
	//let location_of_e = t_as_string.indexOf("e");
	//let inv_magnitude = Number(t_as_string.substr(location_of_e+2));
	if (t.lte(zero())) return "00:00:00" + (do_ms?".000":"");
	let significand = Decimal(t);
	let suffix = 0;
	while (significand.e < 0) {
		//significand = significand.times(1000);
		significand.e += 3;
		suffix++;
	}
	
	if (suffix >= temporal_suffixes.length) {
		while (significand.gte(10)) {
			significand = significand.div(10);
		}
		return significand.toFixed(2) + "e" + t.e + "s";
	}
	return significand.toFixed(2) + temporal_suffixes[suffix];
}

//let buildings = [];
//let upgrades = [];
let default_buy_amounts = [1,10,100,1000,10000,100000,1000000,10000000,100000000]; // bluh
// bleghhhhh
class building {
	constructor(name, display_name, base_speed, base_profit, base_price, base_price_multiplier=1.15, world=earth, buy_amounts=default_buy_amounts, currency=undefined, starting_freebies=0, freebies=0) {
		this.id = world.buildings.length;
		this.display_name = display_name;
		this.name = name;
		this.time = zero();
		this.base_speed = base_speed;
		this.base_profit = base_profit;
		this.base_price = base_price;
		this.base_price_multiplier = base_price_multiplier;
		this.currency = (currency == undefined) ? world.currency : currency;
		this.amount = 0;
		this.profit_multiplier = Decimal(1);
		this.speed_multiplier = Decimal(1);
		this.tiers = [];
		this.starting_freebies = starting_freebies;
		this.freebies = freebies;
		this.world = world;
		this.buy_amounts = buy_amounts;
		// following variables are redundancies for speeding things up
		this.calculated_prices = [];
		this.calculated_profit = zero();
		this.flag_recalculate_prices = true;
		this.flag_recalculate_profit = true;
		//this.unlocked = false;
		this.gui_override_update_price = false;
		this.gui_override_update_amount = true;
		this.gui_override_update_profit = false;
		this.gui_override_update_speed = false;
		this.gui_pos_x = 0;
		this.gui_pos_y = 0;
		
		world.buildings.push(this); // push this building object to the list of building objects to be ticked by the game loop.
		// the code below will create a <div> element for the actual interface of the building and add it to the main building element.
		
		let buildings_element = document.getElementById("buildings");
		this.gui_pos_y = buildings_element.children[0].children[1+this.id].offsetTop + buildings_element.offsetTop;
		let building_element = document.createElement("div");
		building_element.setAttribute("id", name);
		building_element.setAttribute("class", "building");
		building_element.setAttribute("onmouseenter", "focus_currency("+this.world.id+")");
		
		let building_title = document.createElement("h2");
		building_title.setAttribute("class", "title");
		let building_title_innerHTML = document.createTextNode(display_name+" ");
		building_title.appendChild(building_title_innerHTML);
		
		// hide all the details before the first buy
		let building_interface = document.createElement("div");
		building_interface.setAttribute("id", name+"_interface");
		building_interface.setAttribute("style", "display:none;");
		
		let building_amount = document.createElement("div");
		//building_amount.setAttribute("class", "noselect");
		building_amount.setAttribute("style", "color:#ffffff;font-size:1.25em;display:inline;");
		building_amount.setAttribute("id", name+"_amount");
		
		/*<div class="noselect" style="color:#ffffff;font-size:1.25em;display:inline;" id="lemonade_stand_amount">&mdash; 1</div><br>*/
		
		let building_tier = document.createElement("div");
		//building_tier.setAttribute("class", "noselect");
		building_tier.setAttribute("style", "color:#ffffff;font-size:1em;display:inline;");
		building_tier.setAttribute("id", name+"_tier");
		
		/*<div class="noselect" style="color:#ffffff;font-size:1em;display:inline;" id="lemonade_stand_tier">(no tier) &ndash; 9 more to next tier</div><br>*/
		
		let tier_effects = document.createElement("details");
		tier_effects.setAttribute("id", name+"_tier_effects");
		tier_effects.setAttribute("hidden", true);
		
		let tier_effects_summary = document.createElement("summary");
		tier_effects_summary.setAttribute("class", "noselect tier-summary");
		let tier_effects_summary_text = document.createTextNode("tier effects"); // long winded
		tier_effects_summary.appendChild(tier_effects_summary_text);
		
		let tier_effects_desc = document.createElement("p");
		tier_effects_desc.setAttribute("class", "tier-desc");
		tier_effects_desc.setAttribute("id", name+"_tier_desc");
		
		tier_effects.appendChild(tier_effects_summary);
		tier_effects.appendChild(tier_effects_desc);
		
		/*<details id="lemonade_stand_tier_effects" hidden><summary>tier effects</summary><p id="lemonade_stand_tier_desc">(no effects)</p></details><br>*/
		
		//let building_progress_svg = document.createElement("svg");
		//building_progress_svg.setAttribute("width", "328");
		//building_progress_svg.setAttribute("height", "36");
		//building_progress_svg.setAttribute("id", name+"_progress");
		/*building_progress_svg.innerHTML = '<rect width="216" height="36" style="fill:rgb(0,40,0);stroke-width:1;stroke:rgb(0,40,0)" />';
		building_progress_svg.innerHTML += '<rect width="0" height="36" style="fill:rgb(0,150,0);stroke-width:0;stroke:rgb(0,40,0)" />';
		building_progress_svg.innerHTML += '<text x="108" y="24" fill="#cccccc" style="font-size:22px;" class="svgtext noselect">something went wrong</text><text x="224" y="24" fill="white" class="noselect" style="font-size:18px;text-anchor:start;text-align:start;font-family:initial;">00:00:00.000</text>';*/
		
		
		//building_progress_svg.innerHTML += '<rect width="0" height="36" style="fill:rgb(0,150,0);stroke-width:0;stroke:rgb(0,40,0)" />';
		/*
		let bg_rect = document.createElement("rect");
		bg_rect.setAttribute("width", "216");
		bg_rect.setAttribute("height", "36");
		bg_rect.setAttribute("style", "fill:rgb(0,40,0);stroke-width:1;stroke:rgb(0,40,0)");
		bg_rect.ownerSVGElement = building_progress_svg;
		let pg_rect = document.createElement("rect");
		pg_rect.setAttribute("width", "0");
		pg_rect.setAttribute("height", "36");
		pg_rect.setAttribute("style", "fill:rgb(0,150,0);stroke-width:0;stroke:rgb(0,40,0)");
		pg_rect.ownerSVGElement = building_progress_svg;
		let profit_text = document.createElement("text");
		profit_text.setAttribute("x", "108");
		profit_text.setAttribute("y", "24");
		profit_text.setAttribute("fill", "#cccccc");
		profit_text.setAttribute("style", "font-size:22px;");
		profit_text.setAttribute("class", "svgtext noselect");
		profit_text.ownerSVGElement = building_progress_svg;
		let profit_text_innerHTML = document.createTextNode("something went wrong");
		profit_text.appendChild(profit_text_innerHTML);
		let time_text = document.createElement("text");
		time_text.setAttribute("x", "224");
		time_text.setAttribute("y", "24");
		time_text.setAttribute("fill", "white");
		time_text.setAttribute("class", "noselect");
		time_text.setAttribute("style", "font-size:18px;text-anchor:start;text-align:start;font-family:initial;");
		time_text.ownerSVGElement = building_progress_svg;
		building_progress_svg.appendChild(bg_rect);
		building_progress_svg.appendChild(pg_rect);
		building_progress_svg.appendChild(profit_text);
		building_progress_svg.appendChild(time_text);*/
		/*
		<svg width="328" height="36" id="lemonade_stand_progress">
			<rect width="216" height="36" style="fill:rgb(0,40,0);stroke-width:1;stroke:rgb(0,40,0)" />
			<rect width="0" height="36" style="fill:rgb(0,150,0);stroke-width:0;stroke:rgb(0,40,0)" />
			<text x="108" y="24" fill="#cccccc" style="font-size:22px;" class="svgtext noselect">
				something went wrong
			</text>
			<text x="224" y="24" fill="white" class="noselect" style="font-size:18px;text-anchor:start;text-align:start;font-family:initial;">
				00:00:00.000
			</text>
		</svg><br>*/
		
		building_element.appendChild(building_title);
		building_interface.appendChild(building_amount);
		building_interface.appendChild(document.createElement("br"));
		building_interface.appendChild(building_tier);
		building_interface.appendChild(document.createElement("br"));
		building_interface.appendChild(tier_effects);
		building_interface.appendChild(document.createElement("br"));
		building_interface.innerHTML += '<svg width="328" height="36" id="'+name+'_progress"><rect width="216" height="36" style="fill:'+world.progress_bg_color+';stroke-width:1;stroke:'+world.progress_bg_color+'"></rect><rect width="0" height="36" style="fill:'+world.progress_bar_color+';stroke-width:0;stroke:'+world.progress_bg_color+'"></rect><text x="108" y="24" fill="#cccccc" style="font-size:22px;" class="svgtext noselect">something went wrong</text><text x="224" y="24" fill="white" class="noselect" style="font-size:18px;text-anchor:start;text-align:start;font-family:initial;">00:00:00.000</text></svg>';
		//building_element.appendChild(building_progress_svg);
		building_interface.appendChild(document.createElement("br"));
		
		for (let i = 0; i < this.buy_amounts.length; i++) { // this is a bit weird but it makes the code less runny
			let buy_button = document.createElement("button");
			buy_button.setAttribute("class", "button noselect button-disabled");
			buy_button.setAttribute("id", name+"_buy_"+this.buy_amounts[i]);
			buy_button.setAttribute("onclick", name+".buy("+this.buy_amounts[i]+")");
			buy_button.setAttribute("disabled", true);
			let buy_button_innerHTML = document.createTextNode("buy "+beautify(this.buy_amounts[i])+"x");
			buy_button.appendChild(buy_button_innerHTML);
			
			let buy_button_price = document.createElement("div");
			buy_button_price.setAttribute("class", "price-cantafford");
			buy_button_price.setAttribute("id", name+"_price_"+this.buy_amounts[i]);
			
			let buy_button_br = document.createElement("br");
			buy_button_br.setAttribute("id", name+"_button_br_"+this.buy_amounts[i]);
			
			building_interface.appendChild(buy_button);
			building_interface.appendChild(buy_button_price);
			building_interface.appendChild(buy_button_br);
		}
		
		/*<button class="button noselect button-disabled" id="lemonade_stand_buy" onclick="lemonade_stand.buy()" disabled>buy 1x</button>
		<div class="price-cantafford noselect" id="lemonade_stand_price"> ($10.00)</div><br>
		<button class="button noselect button-disabled" id="lemonade_stand_buy_10" onclick="lemonade_stand.buy(10)" disabled>buy 10x</button>
		<div class="price-cantafford noselect" id="lemonade_stand_price_10"> ($10,000.00)</div><br>
		<button class="button noselect button-disabled" id="lemonade_stand_buy_100" onclick="lemonade_stand.buy(100)" disabled>buy 100x</button>
		<div class="price-cantafford noselect" id="lemonade_stand_price_100"> ($1,000,000.00)</div><br>*/
		
		building_element.appendChild(building_interface);
		
		let invest_button_br = document.createElement("br");
		invest_button_br.setAttribute("id", name+"_invest_button_br");
		building_element.appendChild(invest_button_br);
		
		// special button to grab attention to a new unlockable building
		let invest_button = document.createElement("button");
		invest_button.setAttribute("id", name+"_invest_button");
		invest_button.setAttribute("class", "button noselect button-disabled");
		invest_button.setAttribute("onclick", name+".buy()");
		invest_button.setAttribute("disabled", true);
		invest_button.setAttribute("style", "font-size:22px;margin:12px;");
		let invest_button_text = document.createTextNode("Buy for ");
		let invest_button_price = document.createElement("div");
		invest_button_price.setAttribute("style", "display:inline;font-size:22px;");
		invest_button_price.setAttribute("class", "price-cantafford noselect");
		invest_button_price.setAttribute("id", name+"_invest_button_price");
		invest_button.appendChild(invest_button_text);
		invest_button.appendChild(invest_button_price);
		building_element.appendChild(invest_button);
		
		let td = document.createElement("td"); // create its place in the whole table
		td.setAttribute("class", "td-building"); // get rid of 1px padding
		td.setAttribute("style", "vertical-align:top");
		buildings_element.children[0].children[1+this.id].appendChild(td); // put it in the building's place, like a wrapper
		
		buildings_element.children[0].children[1+this.id].children[this.world.id].appendChild(building_element);
		
		this.gui_pos_x = building_element.parentElement.offsetLeft;
		
		// that's soil folks
	}
	tick() {
		if (this.get_amount() > 0) this.time = this.time.plus((cur_loop_time - past_loop_time)/1000);
		if (this.time.gt(this.get_epoch())) { // pretty simple. calculating loopovers here results in out-of-tab production, as well as accurate calculation of profits if speeds begin exceeding the refresh rate of the main game loop.
			this.currency.earn(this.get_profit_after_time());
			this.time = this.time.mod(this.get_epoch()); // that is, the max time
		}/*
		if (this.flag_recalculate_prices) {
			this.recalculate_price_values();
			this.flag_recalculate_prices = false;
		}*/
	}
	get_profit_after_time(t=0) { // argh yeah only really useful for that offline production announcement but whatever
		let loopovers = this.time.plus(t).div(this.get_epoch()).floor();
		return this.get_profit().times(loopovers);
	}
	recalculate_price_values() {
		//let price_of_i = this.base_price.times(this.base_price_multiplier.pow(this.amount-1));
		//let total_price = zero();//Decimal(price_of_i);
		let prices = []; // values
		let sum_multiplier = this.base_price_multiplier.div(this.base_price_multiplier.minus(1));
		for (let i = 0; i < this.buy_amounts.length; i++) { // FAST!!!!!
		// based on the fact that B^n + B^(n-1) + ... + B^2 + B + 1 = (B/B-1)B^n
			let p = this.buy_amounts[i]+this.amount-1;
			let S = this.amount;
			let mult_adjustment = 0;
			if (p-S+1 < 100) mult_adjustment = sum_multiplier / (this.base_price_multiplier.pow(p-S+1));
			let base_multiplier = this.base_price_multiplier.pow(this.buy_amounts[i]+this.amount-1);
			prices.push(base_multiplier.times(sum_multiplier.minus(mult_adjustment)).times(this.base_price));
		}
		/*for (let i = 0; prices.length < this.buy_amounts.length; i++) {
			price_of_i = price_of_i.times(this.base_price_multiplier);
			total_price = total_price.plus(price_of_i);
			if (this.buy_amounts.indexOf(i+1) != -1) prices.push(total_price);
		}*/
		this.calculated_prices = prices;
	}
	get_price(n=1) {
		if (n == 0 || this.buy_amounts.indexOf(n) == -1) return zero();
		//let multiplier = this.base_price_multiplier.pow(this.amount+n-1); // notice, freebies are not taken into account
		//let price_for_n = this.base_price.times(multiplier);
		/*let price_of_i = 0;
		let do_recalculations = this.calculated_price.equals(0) || this.recalculate_price;
		if (do_recalculations) {price_of_i = this.base_price.times(this.base_price_multiplier.pow(this.amount));} // computationally expensive!
		else {price_of_i = this.calculated_price;}
		let total_price = Decimal(price_of_i);
		for (let i = 0; i < n-1; i++) {
			price_of_i = price_of_i.times(this.base_price_multiplier);
			total_price = total_price.plus(price_of_i);
		}
		if (do_recalculations) {this.calculated_price = total_price; this.recalculate_price = false;}*/
		if (this.flag_recalculate_prices) {this.recalculate_price_values(); this.flag_recalculate_prices = false;}
		return this.calculated_prices[this.buy_amounts.indexOf(n)];
	}
	recalculate_profit() {
		let base = this.base_profit.times(this.get_amount()).times(this.profit_multiplier);
		let with_angels = base.times(this.world.total_angel_boost);
		this.calculated_profit = with_angels;
	}
	get_profit() {
		if (this.flag_recalculate_profit) {this.recalculate_profit(); this.flag_recalculate_profit = false;}
		return this.calculated_profit;
	}
	get_epoch() {
		return this.base_speed.div(this.speed_multiplier); // ugh this is so nonsensical
		// base speed (used to be base time, which used to be max time) is the time it takes for this building to complete a profit cycle
		// the "speed" "multiplier" is a number which is multiplicatively modified to be larger
		// the bigger the "multiplier" is, the more division will be applied to the time it takes for the building to finish
		// this will, in turn, make the building faster
		// rrrrr
	}
	get_amount() {
		return this.amount+this.freebies;
	}
	buy(n=1) {
		if (this.currency.get_amount().gte(this.get_price(n))) {
			this.currency.spend(this.get_price(n));
			this.amount += n;
			this.flag_recalculate_prices = true;
			this.flag_recalculate_profit = true;
		}
	}
	on_reset() {
		this.amount = 0;
		this.time = zero();
		this.freebies = this.starting_freebies;
		this.flag_recalculate_prices = true;
	}
	on_unlock() {
		this.gui_override_update_price = true;
	}
	get_save_data() {
		let string = "";
		//string += this.world.name + ":" + this.id + ",";
		string += this.time + ","; // important for buildings which take much much longer than normal
		string += this.amount + ",";
		string += this.freebies;
		return string;
	}
	set_from_save_data(string) {
		let data = string.split(",");
		this.time = Decimal(data[0]);
		this.amount = Number(data[1]);
		this.freebies = Number(data[2]);
	}
}
class upgrade {
	constructor(name, desc, price, action, world=earth, currency=undefined) {
		this.id = world.upgrades.length;
		this.name = name;
		this.desc = desc;
		this.price = price;
		this.action = action;
		this.world = world;
		this.currency = (currency == undefined) ? world.currency : currency;
		this.purchased = false;
		this.fired = false;
		world.upgrades.push(this);
	}
	buy() {
		if (this.currency.get_amount().gte(this.price)) {
			this.currency.spend(this.price);
			this.purchased = true;
			this.remove_button(); // this needs to be here because the refresh is automatically set to not remove purchased buttons (which does make sense)
			refresh_upgrade_buttons(true, this.world); // world defaults to earth, which makes purchasing upgrades on other worlds very tedious; the displayed planet would snap back to earth each time.
		}
	}
	add_button(place) {
		let row = document.getElementById("upgrades_table").children[0].children[1+Math.floor(place/4)];
		let entry = document.createElement("td");
		entry.setAttribute("id", "upgrade"+this.id+"entry");
		let left_padding = (place%4 == 0)?'0':'2'; // alot for an extremely tiny detail but whatever
		let right_padding = (place%4 == 3)?'0':'2';
		entry.setAttribute("style", "padding:2;padding-left:"+left_padding+";padding-right:"+right_padding);
		let button = document.createElement("button");
		button.setAttribute("class", "button noselect button-disabled");
		button.setAttribute("id", "upgrade"+this.id);
		button.setAttribute("style", "width:100%;");
		button.setAttribute("disabled", true);
		button.setAttribute("onclick", this.world.name+".upgrades["+this.id+"].buy()");
		button.setAttribute("upgrade_id", this.id);
		button.setAttribute("world_id", this.world.id);
		
		let name = document.createElement("div");
		name.setAttribute("id", "upgrade"+this.id+"name");
		name.setAttribute("style", "font-family:Arial, Helvetica, sans-serif;");//font-weight:bold;");
		let name_text = document.createTextNode(this.name);
		name.appendChild(name_text);
		
		let desc = document.createElement("div");
		desc.setAttribute("id", "upgrade"+this.id+"desc");
		desc.setAttribute("style", "font-style:italic;font-family:initial;");
		let desc_text = document.createTextNode(this.desc);
		desc.appendChild(desc_text);
		
		let price = document.createElement("div");
		price.setAttribute("id", "upgrade"+this.id+"price");
		price.setAttribute("class", "price-cantafford noselect");
		let price_text = document.createTextNode(money(this.price));
		price.appendChild(price_text);
		
		button.appendChild(name);
		button.appendChild(desc);
		button.appendChild(price);
		entry.appendChild(button);
		row.appendChild(entry);
	}
	remove_button() {
		try {
			get_element("upgrade"+this.id+"entry").remove();
		} catch {
			// better luck next time (the button isn't being drawn, silly!)
		}
	}
	on_reset() {
		this.purchased = false;
	}
	on_unlock() {
		//this.purchased = false; // seriously though why is this a function
	}
	get_save_data() {
		let string = "";
		string += this.purchased?"1":"0";
		return string;
	}
	set_from_save_data(string) {
		this.purchased = string=="1";
	}
	fire_action(flag=true) {
		this.action();
		this.fired = flag;
	}
}
class tier {
	constructor(name, desc, amount, action, building) {
		this.name = name;
		this.desc = desc;
		this.amount = amount;
		this.action = action;
		this.building = building;
		this.fired = false;
		building.tiers.push(this);
	}
	reached() {
		return this.building.get_amount() >= this.amount;
	}
	fire_action(flag=true) {
		this.action();
		this.fired = flag;
	}
}
/* * * Buildings * * */
lemonade_stand = new building("lemonade_stand", "Lemonade Stand", Decimal(2), Decimal(0.50), Decimal(2.00), Decimal(1.15), earth, default_buy_amounts, undefined, 1, 1);
newspaper_delivery = new building("newspaper_delivery", "Newspaper Delivery", Decimal(4), Decimal(10.00), Decimal(25.00), Decimal(1.17), earth);
car_wash = new building("car_wash", "Car Wash", Decimal(9.5), Decimal(210), Decimal(800), Decimal(1.165), earth);
pizza_delivery = new building("pizza_delivery", "Pizza Delivery", Decimal(12), Decimal(650), Decimal(7500), Decimal(1.16), earth);
donut_shop = new building("donut_shop", "Donut Shop", Decimal(30), Decimal(1940), Decimal(30000), Decimal(1.158), earth);
shrimp_boat = new building("shrimp_boat", "Shrimp Boat", Decimal(55), Decimal(24000), Decimal(750000), Decimal(1.156), earth);
hockey_team = new building("hockey_team", "Hockey Team", Decimal(80), Decimal(96500.99), Decimal(1_750_000), Decimal(1.154), earth);
movie_studio = new building("movie_studio", "Movie Studio", Decimal(180), Decimal(500_000), Decimal(6_280_001), Decimal(1.152), earth);
bank = new building("bank", "Bank", Decimal(300), Decimal(37_000_000), Decimal(50_000_000), Decimal(1.151), earth);
oil_company = new building("oil_company", "Oil Company", Decimal(1200), Decimal(2_700_000_000), Decimal(1_000_000_000), Decimal(1.15), earth);
space_rollercoaster = new building("space_rollercoaster", "Space Rollercoaster", Decimal(3600), Decimal('7e+99'), Decimal('1e+100'), Decimal(1.4), earth); // (this and forward are much more expensive)
//antimatter shipment
//cookie factory
//glue
//paperclip machine

moon_shoes = new building("moon_shoes", "Moon Shoes", Decimal(1.5), Decimal(1.00), Decimal(5.00), Decimal(1.14), moon, default_buy_amounts, undefined, 1, 0);
//moon_shoes.freebies = 1; // temp
gravity_booth = new building("gravity_booth", "Gravity Booth", Decimal(3), Decimal(7.00), Decimal(8.00), Decimal(1.145), moon);
//payday clones
//lunar express
//oxygen bar
//helium-3 farm
//cheese mines
//amusement park
//werewolf colony
//giant laser
//moonolith (this and forward are much more expensive)
//bromine plant
//vampire city
//time agents
//destiny reactor
//film lab

potato_stand = new building("potato_stand", "Potato Stand", Decimal(0.5), Decimal(0.05), Decimal(1.00), Decimal(1.05), mars, default_buy_amounts, undefined, 1, 0);
//mars chocolate
//space pirates
//plutonium mines
//giant worms
//portals
//ambassadors
//brain vacations
//space tethers
//terror formers
//starships (this and forward are much more expensive)
//electric cars
//dusters
//asteroid miners
//chocolate bars

//amogus = new building("amogus", "Amogus (2019)", 0.5, 10000n * 100n, 1n * 100n, 1.13, "dollars");
//amogus_tier0 = new tier("sus crewmate", "amogus speed x999", 100, action=()=>{amogus.speed_multiplier*=999;}, "amogus");
//amogus_tier1 = new tier("sus crewmate x2", "amogus speed x999", 200, action=()=>{amogus.speed_multiplier*=999;}, "amogus");

/* * * Upgrades * * */
let multiply_profit =(building, mult)=> {
	return function () {
		building.profit_multiplier = building.profit_multiplier.times(mult);
		building.gui_override_update_profit = true;
		building.flag_recalculate_profit = true;
	}
}
let multiply_speed =(building, mult)=> {
	return function () {
		building.speed_multiplier = building.speed_multiplier.times(mult);
		building.gui_override_update_speed = true;
	}
}
let multiply_world_profit =(world, mult)=> {
	return function () {
		for (let i = 0; i < world.buildings.length; i++) {
			world.buildings[i].profit_multiplier = world.buildings[i].profit_multiplier.times(mult);
			world.buildings[i].gui_override_update_profit = true;
			world.buildings[i].flag_recalculate_profit = true;
		}
	}
}

lemonade_stand_up0 = new upgrade("Paper Umbrellas", "Lemonade Stand profit x3", Decimal(500), multiply_profit(lemonade_stand, 3), earth);
newspaper_delivery_up0 = new upgrade("Lasanga Comics", "Newspaper Delivery profit x3", Decimal(3000), multiply_profit(newspaper_delivery, 3), earth);
car_wash_up0 = new upgrade("Bubblier Soaps", "Car Wash profit x3", Decimal(15000), multiply_profit(car_wash, 3), earth);
pizza_delivery_up0 = new upgrade("Garlic Sauce", "Pizza Delivery profit x3", Decimal(40000), multiply_profit(pizza_delivery, 3), earth);
donut_shop_up0 = new upgrade("Jelly-filled", "Donut Shop profit x3", Decimal(80000), multiply_profit(donut_shop, 3), earth);
shrimp_boat_up0 = new upgrade("Tougher Nets", "Shrimp Boat profit x3", Decimal(900000), multiply_profit(shrimp_boat, 3), earth);
hockey_team_up0 = new upgrade("Aerodynamic Pucks", "Hockey Team profit x3", Decimal(2200000), multiply_profit(hockey_team, 3), earth);
movie_studio_up0 = new upgrade("Filmed on real silver", "Movie Studio profit x3", Decimal(4_400_000), multiply_profit(movie_studio, 3), earth);
bank_up0 = new upgrade("Fancier Pillars", "Bank profit x3", Decimal(160_000_000), multiply_profit(bank, 3), earth);
oil_company_up0 = new upgrade("Rocket Pumps", "Oil Company profit x3", Decimal(5_000_000_000), multiply_profit(oil_company, 3), earth);

everything_up0 = new upgrade("Marketeer", "Everything profit x3", Decimal(10_000_000_000), multiply_world_profit(earth, 3), earth);

lemonade_stand_up1 = new upgrade("Flashy Banners", "Lemonade Stand profit x3", Decimal(15_000_000_000), multiply_profit(lemonade_stand, 3), earth);
newspaper_delivery_up1 = new upgrade("Crossword Puzzles", "Newspaper Delivery profit x3", Decimal(90_000_000_000), multiply_profit(newspaper_delivery, 3), earth);
car_wash_up1 = new upgrade("Absorbier Sponges", "Car Wash profit x3", Decimal(270_000_000_000), multiply_profit(car_wash, 3), earth);
pizza_delivery_up1 = new upgrade("Fresh Toppings", "Pizza Delivery profit x3", Decimal(490_000_000_000), multiply_profit(pizza_delivery, 3), earth);
donut_shop_up1 = new upgrade("Coffee-filled", "Donut Shop profit x3", Decimal(810_000_000_000), multiply_profit(donut_shop, 3), earth);
shrimp_boat_up1 = new upgrade("Larger Water Vehicles", "Shrimp Boat profit x3", Decimal(1_210_000_000_000), multiply_profit(shrimp_boat, 3), earth);
hockey_team_up1 = new upgrade("Slippery Soap Ice", "Hockey Team profit x3", Decimal(2_440_000_000_000), multiply_profit(hockey_team, 3), earth);
movie_studio_up1 = new upgrade("More Outtake Reels", "Movie Studio profit x3", Decimal(4_690_000_000_000), multiply_profit(movie_studio, 3), earth);
bank_up1 = new upgrade("Shorter Sayers", "Bank profit x3", Decimal(8_220_000_000_000), multiply_profit(bank, 3), earth);
oil_company_up1 = new upgrade("Seaside Refineries", "Oil Company profit x3", Decimal(15_000_000_000_678), multiply_profit(oil_company, 3), earth);

everything_up1 = new upgrade("Cleverer Strategies", "Everything profit x3", Decimal('5e+13'), multiply_world_profit(earth, 3), earth);

everything_up2 = new upgrade("Highly Lucrative Proposition", "Everything profit x3", Decimal('5e+16'), multiply_world_profit(earth, 3), earth);

//everything_up? = new upgrade("Oil.", "Everything speed x999", Decimal('1e+????'), multiply_world_speed(earth, 999), earth);

moon_shoes_up0 = new upgrade("Titanium-toed", "Moon Shoes profit x3", Decimal(8000), multiply_profit(moon_shoes, 3), moon);
gravity_booth_up0 = new upgrade("Cushioned Seats", "Gravity Booth profit x3", Decimal(57000), multiply_profit(gravity_booth, 3), moon);

potato_stand_up0 = new upgrade("Fresh Fertilizer", "Potato Stand profit x9", Decimal(10000), multiply_profit(potato_stand, 9), mars);
potato_stand_up1 = new upgrade("Hydrazine Cans", "Potato Stand profit x19", Decimal(10000000), multiply_profit(potato_stand, 19), mars);

/* * * Tiers * * */
lemonade_stand_tier0 = new tier("Lemonade Novice", "Lemonade Stand speed x2", 25, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier1 = new tier("Lemongineer", "Lemonade Stand speed x2", 50, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier2 = new tier("Lemon Officianado", "Lemonade Stand profit x3", 100, multiply_profit(lemonade_stand, 3), lemonade_stand);
lemonade_stand_tier3 = new tier("Professional Juicer", "Lemonade Stand speed x2", 150, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier4 = new tier("Lemondacious", "Lemonade Stand speed x2", 200, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier5 = new tier("Lemon League", "Lemonade Stand speed x2", 250, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier6 = new tier("Citrus Cardinal", "Lemonade Stand speed x2", 300, multiply_speed(lemonade_stand, 2), lemonade_stand);
lemonade_stand_tier7 = new tier("Tacky Ambrosia", "Lemonade Stand profit x3", 350, multiply_profit(lemonade_stand, 3), lemonade_stand);

newspaper_delivery_tier0 = new tier("Extra extra!", "Newspaper Delivery speed x2", 25, multiply_speed(newspaper_delivery, 2), newspaper_delivery);
newspaper_delivery_tier1 = new tier("Today in Business", "Newspaper Delivery profit x2", 50, multiply_profit(newspaper_delivery, 2), newspaper_delivery);
newspaper_delivery_tier2 = new tier("Breaking News", "Newspaper Delivery profit x2", 100, multiply_profit(newspaper_delivery, 2), newspaper_delivery);
newspaper_delivery_tier3 = new tier("Lemonade Advertisements", "Lemonade Stand profit x3", 125, multiply_profit(lemonade_stand, 3), newspaper_delivery);
newspaper_delivery_tier4 = new tier("Soap Samples", "Car Wash profit x3", 150, multiply_profit(car_wash, 3), newspaper_delivery);
newspaper_delivery_tier5 = new tier("Pizza Service Announcements", "Pizza Delivery profit x3", 175, multiply_profit(pizza_delivery, 3), newspaper_delivery);
newspaper_delivery_tier6 = new tier("The Postal Service", "Newspaper Delivery speed x3", 200, multiply_speed(newspaper_delivery, 3), newspaper_delivery);
newspaper_delivery_tier7 = new tier("Donut-shaped Newspapers", "Donut Shop profit x3", 225, multiply_profit(donut_shop, 3), newspaper_delivery);

car_wash_tier0 = new tier("Soap Novice", "Car Wash speed x2", 25, multiply_speed(car_wash, 2), car_wash);
car_wash_tier1 = new tier("Cleanliness Agent", "Car Wash profit x2", 50, multiply_profit(car_wash, 2), car_wash);
car_wash_tier2 = new tier("Avid Soap-Salesman", "Car Wash profit x2", 100, multiply_profit(car_wash, 2), car_wash);
car_wash_tier3 = new tier("Cleaning Enthusiast", "Car Wash profit x2", 150, multiply_profit(car_wash, 2), car_wash);
car_wash_tier4 = new tier("Stepping on the gas", "Car Wash speed x2", 200, multiply_speed(car_wash, 2), car_wash);
car_wash_tier5 = new tier("Driving the Sterile-brick Road", "Car Wash profit x2", 250, multiply_profit(car_wash, 2), car_wash);

pizza_delivery_tier0 = new tier("Pizza Time", "Pizza Delivery speed x2", 25, multiply_speed(pizza_delivery, 2), pizza_delivery);
pizza_delivery_tier1 = new tier("Pizza Parlor", "Pizza Delivery speed x2", 50, multiply_speed(pizza_delivery, 2), pizza_delivery);
pizza_delivery_tier2 = new tier("Pizza Pie", "Pizza Delivery speed x2", 100, multiply_speed(pizza_delivery, 2), pizza_delivery);
pizza_delivery_tier3 = new tier("Perfect Pizza", "Pizza Delivery profit x2", 150, multiply_profit(pizza_delivery, 2), pizza_delivery);
pizza_delivery_tier4 = new tier("and Presto! It's Pizza!", "Pizza Delivery profit x2", 200, multiply_profit(pizza_delivery, 2), pizza_delivery);
pizza_delivery_tier5 = new tier("Pizza Particles", "Pizza Delivery profit x2", 250, multiply_profit(pizza_delivery, 2), pizza_delivery);

donut_shop_tier0 = new tier("A Holey Investment", "Donut Shop speed x2", 25, multiply_speed(donut_shop, 2), donut_shop);
donut_shop_tier1 = new tier("Icing on the top", "Donut Shop profit x3", 50, multiply_profit(donut_shop, 3), donut_shop);
donut_shop_tier2 = new tier("Nothing beats it", "Donut Shop profit x3", 100, multiply_profit(donut_shop, 3), donut_shop);
donut_shop_tier3 = new tier("It's spelled \"Doughnut\"", "Doughnut Shop profit x2", 150, multiply_profit(donut_shop, 2), donut_shop);
donut_shop_tier4 = new tier("Can't believe I ate the Hole thing!", "Donut Shop profit x2", 200, multiply_profit(donut_shop, 2), donut_shop);
donut_shop_tier5 = new tier("Harmony of the Bread Tori", "Donut Shop profit x2", 250, multiply_profit(donut_shop, 2), donut_shop);

shrimp_boat_tier0 = new tier("On the high seas", "Shrimp Boat profit x2", 25, multiply_profit(shrimp_boat, 2), shrimp_boat);
shrimp_boat_tier1 = new tier("Making a Krilling", "Shrimp Boat profit x2", 50, multiply_profit(shrimp_boat, 2), shrimp_boat);
shrimp_boat_tier2 = new tier("Crustaceous", "Shrimp Boat profit x3", 100, multiply_profit(shrimp_boat, 3), shrimp_boat);
shrimp_boat_tier3 = new tier("It's that shrimple!", "Shrimp Boat speed x2", 150, multiply_speed(shrimp_boat, 2), shrimp_boat);
shrimp_boat_tier4 = new tier("Shrimped out", "Shrimp Boat profit x3", 200, multiply_profit(shrimp_boat, 3), shrimp_boat);
shrimp_boat_tier5 = new tier("Shrimped to meet you!", "Shrimp Boat speed x2", 250, multiply_speed(shrimp_boat, 2), shrimp_boat);

hockey_team_tier0 = new tier("Welcome to Canada!", "Hockey Team speed x2", 25, multiply_speed(hockey_team, 2), hockey_team);
hockey_team_tier1 = new tier("Figure Skater", "Hockey Team speed x2", 50, multiply_speed(hockey_team, 2), hockey_team);
hockey_team_tier2 = new tier("A fine game of Sportsdisc", "Hockey Team speed x2", 100, multiply_speed(hockey_team, 2), hockey_team);
hockey_team_tier3 = new tier("Teeth for a year", "Hockey Team speed x2", 150, multiply_speed(hockey_team, 2), hockey_team);
hockey_team_tier4 = new tier("Play ball!", "Hockey Team profit x4", 200, multiply_profit(hockey_team, 4), hockey_team);

movie_studio_tier0 = new tier("Starring: You", "Movie Studio speed x2", 25, multiply_speed(movie_studio, 2), movie_studio);
movie_studio_tier1 = new tier("Filmography", "Movie Studio speed x2", 50, multiply_speed(movie_studio, 2), movie_studio);
movie_studio_tier2 = new tier("What a Classic!", "Movie Studio profit x2", 100, multiply_profit(movie_studio, 2), movie_studio);
movie_studio_tier3 = new tier("The Stage is set", "Movie Studio profit x2", 150, multiply_profit(movie_studio, 2), movie_studio);
movie_studio_tier4 = new tier("Lights,", "Movie Studio speed x2", 200, multiply_speed(movie_studio, 2), movie_studio);

bank_tier0 = new tier("The root of all evil", "Bank profit x3", 25, multiply_profit(bank, 3), bank);
bank_tier1 = new tier("Vested Interest", "Bank profit x3", 50, multiply_profit(bank, 3), bank);

oil_company_tier0 = new tier("A product to change the world", "Earth profit x3", 5, multiply_world_profit(earth, 3), oil_company);
oil_company_tier1 = new tier("Black Gold", "Oil Company profit x3", 25, multiply_profit(oil_company, 3), oil_company);

moon_shoes_tier0 = new tier("One Small Step", "Moon Shoes speed x3", 25, multiply_speed(moon_shoes, 3), moon_shoes);
moon_shoes_tier1 = new tier("And a Giant Leap", "Moon Shoes speed x2", 50, multiply_speed(moon_shoes, 2), moon_shoes);
moon_shoes_tier2 = new tier("For profits!", "Moon Shoes speed x2", 100, multiply_speed(moon_shoes, 2), moon_shoes);
moon_shoes_tier3 = new tier("Moon running with moon scissors", "Moon Shoes speed x2", 150, multiply_speed(moon_shoes, 2), moon_shoes);

gravity_booth_tier0 = new tier("Boioioing", "Gravity Booth profit x3", 25, multiply_profit(gravity_booth, 3), gravity_booth);
gravity_booth_tier1 = new tier("Firmly Planted", "Gravity Booth profit x3", 50, multiply_profit(gravity_booth, 3), gravity_booth);
gravity_booth_tier2 = new tier("Well, it's gravity", "Gravity Booth speed x2", 100, multiply_speed(gravity_booth, 2), gravity_booth);

potato_stand_tier0 = new tier("Hey There!", "Potato Stand profit x4", 25, multiply_profit(potato_stand, 4), potato_stand);

let n_shown_upgrades = 8;
function refresh_upgrade_buttons(remove=true, world=earth, destroy_elements=false) {
	if (Number(get_element("upgrades_world_selector").value) != world.id) return; // don't try to mess with stuff if it isn't actually being displayed/updated.
	let i = 0;
	let place_to_fill = 0;
	//console.log("changed to "+world.id);
	if (destroy_elements) {
		for (let i = 0; i < 64; i++) { // this simply clears all buttons which happen to be in the actual panel element, as opposed to removing ones that are supposed to be there.
			try {
				let upgrade_element = get_element("upgrades_table").children[0].children[1+Math.floor(i/4)].children[0].children[0];
				let id = upgrade_element.getAttribute("upgrade_id");
				let world = worlds[upgrade_element.getAttribute("world_id")];
				world.upgrades[id].remove_button();
			} catch {
				break; // there probably isn't a button there, which means there must be no buttons there.
			}
		}
	}
	for (let i = 0; i < world.upgrades.length; i++) {
		if (!world.upgrades[i].purchased) {
			if (remove) world.upgrades[i].remove_button(); // this removes the old buttons before adding new ones. we shouldn't do this if the buttons have never been drawn before, hence the remove option.
			world.upgrades[i].add_button(place_to_fill);
			try { // this function runs once before the gui vars are initialized, which means this can actually cause a ReferenceError (for some reason)
				GUI_can_afford_upgrade[world.id][i] = null;
			} catch (err) {}
			place_to_fill++;
		}
		if (place_to_fill >= n_shown_upgrades) break;
	}
}
refresh_upgrade_buttons(false);
get_element("upgrades_world_selector").addEventListener("change", function(event) {
	GUI_update_upgrades_display_world = true;
});
get_element("angels_world_selector").addEventListener("change", function(event) {
	GUI_update_angels_display_world = true;
});
get_element("upgrades_amount_displayed").addEventListener("change", function(event) {
	n_shown_upgrades = Number(event.target.value);
	GUI_update_upgrades_display_world = true; // idk invoking this sounds cool
});

function is_element_visible(element) { // thank you
	/*let rect = element.getBoundingClientRect();
	let view_height = Math.max(document.documentElement.clientHeight, window.innerHeight);
	return !(rect.bottom < 0 || rect.top - view_height >= 0);*/
	return true;
}

function get_time() {
	//let t = new Date();
	return Date.now();//t.getTime();
}

function get_game_save_data() {
	let savedata = cur_loop_time + "/" + game_version + "/";
	for (let w = 0; w < worlds.length; w++) {
		savedata += worlds[w].get_save_data() + "|";
	}
	savedata = btoa(savedata);
	//console.log("saved game");
	return savedata;
}

function save_to_localStorage() {
	window.localStorage.setItem("capitalsim_savedata", get_game_save_data()); //aaand save
	announce("game saved","#666666",3500);
}
function save_to_export() {
	//announce("here's your save data, make sure to copy it and keep it somewhere safe: "+get_game_save_data(),"#00ff00");
	let import_export_window = get_element("import_export_window");
	import_export_window.classList.remove("hidden");
	import_export_window.disabled = true;
	import_export_window.value = get_game_save_data();
	let import_export_info = get_element("import_export_info");
	import_export_info.innerHTML = "<br>copy the above code! (make sure to get all of it!)<br>";
	get_element("confirm_import_button").classList.add("hidden");
}

//file save function from https://github.com/eligrey/FileSaver.js
//taken from cookie clicker v2.048
// actually a whole tonne of this save/load code was taken from cookie clicker (most notably saveAs and load_from_file)
// sorry orteil
var saveAs=saveAs||function(view){"use strict";if(typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var doc=view.document,get_URL=function(){return view.URL||view.webkitURL||view},save_link=doc.createElementNS("http://www.w3.org/1999/xhtml","a"),can_use_save_link="download"in save_link,click=function(node){var event=new MouseEvent("click");node.dispatchEvent(event)},is_safari=/Version\/[\d\.]+.*Safari/.test(navigator.userAgent),webkit_req_fs=view.webkitRequestFileSystem,req_fs=view.requestFileSystem||webkit_req_fs||view.mozRequestFileSystem,throw_outside=function(ex){(view.setImmediate||view.setTimeout)(function(){throw ex},0)},force_saveable_type="application/octet-stream",fs_min_size=0,arbitrary_revoke_timeout=500,revoke=function(file){var revoker=function(){if(typeof file==="string"){get_URL().revokeObjectURL(file)}else{file.remove()}};if(view.chrome){revoker()}else{setTimeout(revoker,arbitrary_revoke_timeout)}},dispatch=function(filesaver,event_types,event){event_types=[].concat(event_types);var i=event_types.length;while(i--){var listener=filesaver["on"+event_types[i]];if(typeof listener==="function"){try{listener.call(filesaver,event||filesaver)}catch(ex){throw_outside(ex)}}}},auto_bom=function(blob){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(blob.type)){return new Blob(["\ufeff",blob],{type:blob.type})}return blob},FileSaver=function(blob,name,no_auto_bom){if(!no_auto_bom){blob=auto_bom(blob)}var filesaver=this,type=blob.type,blob_changed=false,object_url,target_view,dispatch_all=function(){dispatch(filesaver,"writestart progress write writeend".split(" "))},fs_error=function(){if(target_view&&is_safari&&typeof FileReader!=="undefined"){var reader=new FileReader;reader.onloadend=function(){var base64Data=reader.result;target_view.location.href="data:attachment/file"+base64Data.slice(base64Data.search(/[,;]/));filesaver.readyState=filesaver.DONE;dispatch_all()};reader.readAsDataURL(blob);filesaver.readyState=filesaver.INIT;return}if(blob_changed||!object_url){object_url=get_URL().createObjectURL(blob)}if(target_view){target_view.location.href=object_url}else{var new_tab=view.open(object_url,"_blank");if(new_tab==undefined&&is_safari){view.location.href=object_url}}filesaver.readyState=filesaver.DONE;dispatch_all();revoke(object_url)},abortable=function(func){return function(){if(filesaver.readyState!==filesaver.DONE){return func.apply(this,arguments)}}},create_if_not_found={create:true,exclusive:false},slice;filesaver.readyState=filesaver.INIT;if(!name){name="download"}if(can_use_save_link){object_url=get_URL().createObjectURL(blob);setTimeout(function(){save_link.href=object_url;save_link.download=name;click(save_link);dispatch_all();revoke(object_url);filesaver.readyState=filesaver.DONE});return}if(view.chrome&&type&&type!==force_saveable_type){slice=blob.slice||blob.webkitSlice;blob=slice.call(blob,0,blob.size,force_saveable_type);blob_changed=true}if(webkit_req_fs&&name!=="download"){name+=".download"}if(type===force_saveable_type||webkit_req_fs){target_view=view}if(!req_fs){fs_error();return}fs_min_size+=blob.size;req_fs(view.TEMPORARY,fs_min_size,abortable(function(fs){fs.root.getDirectory("saved",create_if_not_found,abortable(function(dir){var save=function(){dir.getFile(name,create_if_not_found,abortable(function(file){file.createWriter(abortable(function(writer){writer.onwriteend=function(event){target_view.location.href=file.toURL();filesaver.readyState=filesaver.DONE;dispatch(filesaver,"writeend",event);revoke(file)};writer.onerror=function(){var error=writer.error;if(error.code!==error.ABORT_ERR){fs_error()}};"writestart progress write abort".split(" ").forEach(function(event){writer["on"+event]=filesaver["on"+event]});writer.write(blob);filesaver.abort=function(){writer.abort();filesaver.readyState=filesaver.DONE};filesaver.readyState=filesaver.WRITING}),fs_error)}),fs_error)};dir.getFile(name,{create:false},abortable(function(file){file.remove();save()}),abortable(function(ex){if(ex.code===ex.NOT_FOUND_ERR){save()}else{fs_error()}}))}),fs_error)}),fs_error)},FS_proto=FileSaver.prototype,saveAs=function(blob,name,no_auto_bom){return new FileSaver(blob,name,no_auto_bom)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(blob,name,no_auto_bom){if(!no_auto_bom){blob=auto_bom(blob)}return navigator.msSaveOrOpenBlob(blob,name||"download")}}FS_proto.abort=function(){var filesaver=this;filesaver.readyState=filesaver.DONE;dispatch(filesaver,"abort")};FS_proto.readyState=FS_proto.INIT=0;FS_proto.WRITING=1;FS_proto.DONE=2;FS_proto.error=FS_proto.onwritestart=FS_proto.onprogress=FS_proto.onwrite=FS_proto.onabort=FS_proto.onerror=FS_proto.onwriteend=null;return saveAs}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!=null){define([],function(){return saveAs})}

function save_to_file() {
	let date = new Date();
	let month = date.getMonth();
	let day = date.getDate();
	let time = date.getFullYear()+'_'+(month<9?'0':'')+(month+1)+(day<10?'0':'')+(day);
	let blob = new Blob([get_game_save_data()], {type:'text/plain;charset=utf-8'});
	saveAs(blob,'capitalsim_save_'+time+'.txt');
}

function load_game_from_data(savedata) {
	if (savedata==null) return false;
	try {savedata = atob(savedata);}
	catch (err) {console.log("savedata was not base64 encoded (or some other error occurred). loading as unencoded string. err: "+err);}
	past_loop_time = savedata.split("/")[0];
	savefile_version = savedata.split("/")[1];
	//game_updated = savefile_version < game_version;
	savedata = savedata.substr(savedata.lastIndexOf("/")+1);
	let worlds_data = savedata.split("|");
	for (let w = 0; w < worlds.length; w++) {
		//console.log("loading world "+w);
		//console.log(worlds_data[w]);
		worlds[w].set_from_save_data(worlds_data[w]);
		if (worlds[w].unlocked) worlds[w].unhide_option_in_selectors();
	}
	announce("game loaded!","#555555",2000);
	// done!
	return true;
}

function load_from_localStorage() {
	return load_game_from_data(window.localStorage.getItem("capitalsim_savedata")); //aaand load
}

function load_from_import() {
	let import_export_window = get_element("import_export_window");
	import_export_window.classList.remove("hidden");
	import_export_window.disabled = false;
	import_export_window.value = "";
	get_element("import_export_info").innerHTML = "<br>paste your savedata above, then press \"Import\" to load your save<br>";
	get_element("confirm_import_button").classList.remove("hidden");
}
function confirm_import() {
	successful = load_game_from_data(get_element("import_export_window").value);
	if (successful) {
		get_element("import_export_info").innerHTML = "<br>import successful!<br>";
		get_element("import_export_window").classList.add("hidden");
	}
	else {
		get_element("import_export_info").innerHTML = "error! load failed!";
	}
	get_element("confirm_import_button").classList.add("hidden");
}

function load_from_file(event) {
	let file = event.target.files[0];
	let reader = new FileReader();
	reader.onload = function(event) {
		load_game_from_data(event.target.result);
	}
	reader.readAsText(file);
}

function wipe_save() {
	window.localStorage.removeItem("capitalsim_savedata");
}

function sum(l) {
	let sum = 0;
	for (let i = 0; i < l.length; i++) sum += l[i];
	return sum;
}

function random_color(intensity=1) {
	let random_numbers = (()=>{let h=[];for (let i=0;i<3;i++){h.push(Math.floor(Math.random()*256))}return h;})();
	let intensity_adjusted = [];
	for (let i = 0; i < 3; i++) {
		intensity_adjusted.push(Math.floor(
		((sum(random_numbers)/3) * (1-intensity)) +
		(random_numbers[i] * intensity)
		));
	}
	let random_number = "";
	for (let i = 0; i < 3; i++) {
		random_number += (intensity_adjusted[i]<16?"0":"")+intensity_adjusted[i].toString(16);
	}
	random_number = Number("0x"+random_number);
	random_number = (random_number + (random_number<0x555555?0x555555:0)).toString(16);
	return "#" + /*("0".repeat(6-random_number.length)) + */random_number;
}

function announce(text, color=undefined, time=0) {
	if (color == undefined) {
		color = random_color();
	}
	let announcement = document.createElement("div");
	announcement.setAttribute("style", "color:"+color+";");
	announcement.innerHTML = text;
	let announcements = get_element("announcements");
	announcements.insertBefore(announcement, announcements.children[0]);
	if (announcements.children.length > 50) announcements.removeChild(announcements.lastElementChild);
	if (time != 0) {
		let timeout = setTimeout(()=>{announcements.removeChild(announcement)}, time);
	}
	return announcement;
}/* rip funny function name (superceded/subsumed by the time functionality of announce)
function unnounce(element) {
	get_element("announcements").removeChild(element);
}*/

let should_autosave = false;
let autosave_time = 60000;
function autosave_loop() {
	should_autosave = true;
	setTimeout(autosave_loop, autosave_time);
}
setTimeout(autosave_loop, autosave_time);

/* it'&/s time */
let past_loop_time = get_time();
let cur_loop_time = get_time();
let dt = 0; // delta t
let dts = []; // track record of last 60 dts
let mft = 0; // mean frametime
let fps = 0; // frames per second
let tof = 0; // time of frames
let nof = 0; // number of frames
let tpf = 0; // time per frame
barrelroll =()=> {roll=true;}
let roll = false;

/* special vars for gui updates / redundancies for optimizing */
let GUI_moon_unlocked = null;
let GUI_show_cost_of_next_angel = null;
let GUI_buildings_unlocked = []; // oh boy
let GUI_building_amounts = []; // oh boy x2
let GUI_buy_qty_buttons_unlocked = []; // oh boy x3
let GUI_buy_qty_buttons_buyable = []; // oh boy x4
let GUI_can_afford_upgrade = []; // oh boy x5
for (let w = 0; w < worlds.length; w++) {
	let array = new Array(worlds[w].buildings.length).fill(false);
	GUI_buildings_unlocked.push([].concat(array));
	let amounts = new Array(worlds[w].buildings.length).fill(-1);
	GUI_building_amounts.push([].concat(amounts));
	
	let unlocked_buttons = new Array(worlds[w].buildings.length);
	for (let i = 0; i < worlds[w].buildings.length; i++) {
		unlocked_buttons[i] = new Array(worlds[w].buildings[i].buy_amounts.length).fill(null);
	}
	GUI_buy_qty_buttons_unlocked.push([...unlocked_buttons]);
	// sorry for having two copies of the same code here but right now i can't figure out how to bypass javascript's insatiable hunger for not deep-copying lists.
	let buyable_buttons = new Array(worlds[w].buildings.length);
	for (let i = 0; i < worlds[w].buildings.length; i++) {
		buyable_buttons[i] = new Array(worlds[w].buildings[i].buy_amounts.length).fill(null);
	}
	GUI_buy_qty_buttons_buyable.push([...buyable_buttons]);
	
	GUI_can_afford_upgrade.push([].concat(Array(worlds[w].upgrades.length).fill(null)));
	// leaving space for any other building/world-specific metadata that needs to be kept track of
}
let GUI_number_formatting = -1; // used for letting the price labels know that they should get updated
let GUI_displayed_currency = 0;
let GUI_currency_box_pos = new Array(worlds.length).fill(0);
let GUI_displayed_upgrades = 0; // referring to which active world, not amount of upgrade buttons onpage
let GUI_displayed_angels = 0;
let GUI_update_upgrades_display_world = true;
let GUI_update_angels_display_world = true;

let focus_currency =(world)=> {GUI_displayed_currency = world;}
let loaded = load_from_localStorage();

let time_since_last_online = cur_loop_time - past_loop_time;
let seconds = Math.floor(time_since_last_online/1000);
let minutes = Math.floor(seconds/60);
let hours = Math.floor(minutes/60);
let days = Math.floor(hours/24);
seconds %= 60;
minutes %= 60;
hours %= 24;
// this is not how offline profit is actually applied. the profit you earn from offline time is automatically factored in because the past_loop_time is saved with the savedata. offline profit comes as a natural consequence of the main loop.
/*let profits_display = "";
for (let w = 0; w < worlds.length; w++) {
	if (worlds[w].unlocked) {
		let offline_profit = zero();
		for (let i = 0; i < worlds[w].buildings.length; i++) {
			offline_profit = offline_profit.add(worlds[w].buildings[i].get_profit_after_time(time_since_last_online/1000));
			console.log('wawa - '+worlds[w].total_angel_boost);
		}
		profits_display += money(offline_profit, worlds[w].currency.symbol) + (w!=worlds.length-2?", "+(w==worlds.length-3?"and ":''):'');
	}
}*/ // this is impossible to do this way
if (loaded) {announce("welcome back! you "/*made "+profits_display+", and*/+" were gone for "+(days>0?days+" day"+(days!=1?'s':'')+", ":"")+(hours>0?hours+" hour"+(hours!=1?'s':'')+", ":"")+(minutes+" minute"+(minutes!=1?'s':'')+(days>0?'':", "))+(days<1?seconds+" second"+(seconds!=1?'s':''):"")+"!", random_color(game_updated()?0.1:1));}
else {
	announce("welcome to capitalsim! this is a silly game where you make money at an exponentially increasing rate.");
}
if (game_updated()) announce("the game has been updated since you last played it (which was v."+savefile_version+")! welcome to v."+game_version+"!", random_color());

function loop() {
	cur_loop_time = get_time();
	let currently_displayed_upgrades = 0;
	get_element("upgrades_title").attributes.class.value = "title";
	let gui_formatting_changed = (GUI_number_formatting != formatting_mode);
	let gui_transition_speed = get_element("currency_transition_speed").value;
	get_element("displayed_transition_speed").innerHTML = gui_transition_speed;
	GUI_displayed_upgrades = Number(get_element("upgrades_world_selector").value); // it scares me how sensitive to loop timing this thing is. if you put it after the upgrades render update loop, it will try grabbing button elements that existed the frame before. keep this thing here!
	if (GUI_update_upgrades_display_world) {
		let world_id = get_element("upgrades_world_selector").selectedIndex;
		let world = worlds[world_id];
		refresh_upgrade_buttons(true, world, true);
		focus_currency(world_id);
		GUI_update_upgrades_display_world = false;
	}
	if (GUI_update_angels_display_world) {
		let world_id = get_element("angels_world_selector").selectedIndex;
		focus_currency(world_id);
		GUI_update_angels_display_world = false;
	}
	if (should_autosave) {
		should_autosave = false;
		save_to_localStorage();
	}
	
	for (let w = 0; w < worlds.length; w++) {
		let world = worlds[w];
		let upgrades = world.upgrades;
		let buildings = world.buildings;
		let currency = world.currency;
		world.currency.tick();
		world.calculate_claimable_angels();
		world.calculate_cost_of_next_angel();
		world.calculate_total_angel_boost();
		/* * * check loops * * */ // why are they called that though (what was c actually for???????????????)
		for (let c = 0; c < upgrades.length; c++) { // first, fire all non-fired, purchased upgrades (c is for check)
			if (upgrades[c].purchased) {
				if (!upgrades[c].fired) {
					upgrades[c].fire_action();
				}
			}
		}
		for (let c = 0; c < buildings.length; c++) { // and all tiers
			for (let cc = 0; cc < buildings[c].tiers.length; cc++) {
				if (!buildings[c].tiers[cc].fired && buildings[c].tiers[cc].reached()) {
					buildings[c].tiers[cc].fire_action();
					//console.log('fired tier '+buildings[c].tiers[cc].name);
				}
			}
		}
		// this ensures that building order is equal; the last building can tierboost the first building within the first frame.
		
		for (let i = 0; i < upgrades.length; i++) {
			if (upgrades[i].purchased) {
				// if (!upgrades[i].fired) upgrades[i].fire_action(); please refer to the check loops
			} else {
				if (GUI_displayed_upgrades == world.id) { // we can't update button graphics if the buttons are in another world!
					let can_afford = upgrades[i].currency.get_amount().gte(upgrades[i].price);
					if (can_afford != GUI_can_afford_upgrade[w][i]) {
						get_element("upgrade"+upgrades[i].id+"price").setAttribute("class", "price-can"+(can_afford ? "" : "t")+"afford noselect");
						get_element("upgrade"+upgrades[i].id).setAttribute("class", "button noselect button-"+(can_afford ? "enabled" : "disabled"));
						get_element("upgrade"+upgrades[i].id).disabled = !can_afford;
						if (can_afford) get_element("upgrades_title").attributes.class.value = "title important-text";
						GUI_can_afford_upgrade[w][i] = can_afford;
					}
					if (GUI_number_formatting != formatting_mode) { // this cannot be updated in tandem with the affordness check but that's okay
						get_element("upgrade"+upgrades[i].id+"price").innerHTML = money(upgrades[i].price, currency.symbol);
					}
					currently_displayed_upgrades++;
				}
			}
			if (currently_displayed_upgrades >= n_shown_upgrades) break;
		}
		for (let i = 0; i < buildings.length; i++) {
			let building_unlocked = buildings[i].get_amount() > 0;
			if (GUI_buildings_unlocked[w][i] != building_unlocked) {
				//GUI_buildings_unlocked[w][i] = building_unlocked; // at world at building
				if (building_unlocked) {
					get_element(buildings[i].name).hidden = false;
					get_element(buildings[i].name+"_interface").setAttribute("style", "display:contents;");
					get_element(buildings[i].name+"_invest_button").setAttribute("style", "display:none;");
					get_element(buildings[i].name+"_invest_button_br").setAttribute("style", "display:none;");
				} else {
					get_element(buildings[i].name).hidden = true;
					get_element(buildings[i].name+"_interface").setAttribute("style", "display:none;");
					get_element(buildings[i].name+"_invest_button").setAttribute("style", "font-size:22px;margin:12px;");
					get_element(buildings[i].name+"_invest_button_br").setAttribute("style", "display:initial;");
				}
			}
			let gui_update_prices = buildings[i].flag_recalculate_prices || gui_formatting_changed || buildings[i].gui_override_update_price; // wow i don't even need a big list of lists thingy nice. this is before tick because tick will reset the recalculate_prices boolean if it's true.
			let gui_update_amount_info = (GUI_building_amounts[w][i] != buildings[i].get_amount()) || gui_formatting_changed || buildings[i].gui_override_update_amount; // includes info pertaining to tiers and the profit indicator on the progress bar
			
			if (buildings[i].get_amount() > 0) {
				let full_tier_desc = "";
				for (let ii = 0; ii < buildings[i].tiers.length; ii++) {
					if (buildings[i].tiers[ii].reached()) {
						//if (!buildings[i].tiers[ii].fired) buildings[i].tiers[ii].fire_action(); please refer to the check loops
						if (ii != 0) full_tier_desc += "<br>";
						full_tier_desc += buildings[i].tiers[ii].amount + " &ndash; " + buildings[i].tiers[ii].name + ": " + buildings[i].tiers[ii].desc;
					}
					else {
						let tier_name = "";
						if (ii > 0) tier_name = buildings[i].tiers[ii-1].name;
						else tier_name = "(no tier)";
						if (gui_update_amount_info) {
							get_element(buildings[i].name+"_tier").innerHTML = "Tier " + ii + ": " + tier_name + " &ndash; " + (buildings[i].tiers[ii].amount - buildings[i].get_amount()) + " more until next tier";
						}
						//full_tier_desc += tier_desc;
						break;
					}
					if (ii == buildings[i].tiers.length - 1) { // we didn't hit that preemptive break, so we must be at the end.
						if (gui_update_amount_info) {
							get_element(buildings[i].name+"_tier").innerHTML = "Tier " + (ii+1).toString() + ": " + buildings[i].tiers[ii].name + " &ndash; tier MAX";
						}
						//full_tier_desc += buildings[i].tiers[ii].desc;
					}
				}
				if (gui_update_amount_info) {
					get_element(buildings[i].name+"_tier_desc").innerHTML = full_tier_desc;
					get_element(buildings[i].name+"_tier_effects").hidden = full_tier_desc == "";
				}
				
				buildings[i].tick();
				
				let progress_graphic = get_element(buildings[i].name+"_progress");
				if (is_element_visible(get_element(buildings[i].name))) {
				progress_graphic.children[1].attributes.width.value = (buildings[i].time / buildings[i].get_epoch()) * 216;
				}
				if (gui_update_amount_info || buildings[i].gui_override_update_profit) {
					let profit_string = money(buildings[i].get_profit(), currency.symbol);
					progress_graphic.children[2].innerHTML = profit_string;
					progress_graphic.children[2].attributes.style.value = "font-size:"+(22 - (profit_string.length / 4.35))+"px;";
					buildings[i].gui_override_update_profit = false;
				}//"font-family:initial;font-size:"+(22 - (profit_string.length / 5))+"px;text-align:center;text-anchor:middle;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;-moz-user-select:none;-ms-user-select:none;";
				
				if (!buildings[i].get_epoch().lte(1) || buildings[i].gui_override_update_speed) {
					let displayed_time = buildings[i].get_epoch();
					if (displayed_time > 1) displayed_time = displayed_time.minus(buildings[i].time);
					progress_graphic.children[3].innerHTML = as_time(displayed_time, buildings[i].get_epoch().lte(1));
					buildings[i].gui_override_update_speed = false;
				}
				
				if (gui_update_amount_info) {
					get_element(buildings[i].name+"_amount").innerHTML = "&mdash; " + beautify(buildings[i].get_amount());
				}
				
				for (let qty = 0; qty < buildings[i].buy_amounts.length; qty++) {
					let unlocked = currency.get_all_time().gte(buildings[i].get_price(Number(buildings[i].buy_amounts[qty])).div(5000000)) || (GUI_buy_qty_buttons_unlocked[w][i][qty]?true:false); // the || is so that once it's unlocked, it stays so.
					if (GUI_buy_qty_buttons_unlocked[w][i][qty] != unlocked) {
						if (!unlocked) {
							get_element(buildings[i].name+"_price_"+buildings[i].buy_amounts[qty]).className = "hidden";
							get_element(buildings[i].name+"_buy_"+buildings[i].buy_amounts[qty]).className = "hidden";
							get_element(buildings[i].name+"_button_br_"+buildings[i].buy_amounts[qty]).className = "hidden";
						}
						else {
							//get_element(buildings[i].name+"_price_"+buildings[i].buy_amounts[qty]).className = "";
							//get_element(buildings[i].name+"_buy_"+buildings[i].buy_amounts[qty]).className = "";
							get_element(buildings[i].name+"_button_br_"+buildings[i].buy_amounts[qty]).className = "";
						}
						GUI_buy_qty_buttons_unlocked[w][i][qty] = unlocked;
					}
					if (unlocked) {
						let can_purchase = currency.get_amount().gte(buildings[i].get_price(Number(buildings[i].buy_amounts[qty])));
						if (gui_update_prices || GUI_buy_qty_buttons_buyable[w][i][qty] != can_purchase) {
							get_element(buildings[i].name+"_price_"+buildings[i].buy_amounts[qty]).innerHTML = " (" + money(buildings[i].get_price(Number(buildings[i].buy_amounts[qty])), currency.symbol) + ")";
						}
						
						if (GUI_buy_qty_buttons_buyable[w][i][qty] != can_purchase) {
							get_element(buildings[i].name+"_price_"+buildings[i].buy_amounts[qty]).className = can_purchase ? "price-canafford" : "price-cantafford";
							get_element(buildings[i].name+"_buy_"+buildings[i].buy_amounts[qty]).className = can_purchase ? "button noselect button-enabled" : "button noselect button-disabled";
							get_element(buildings[i].name+"_buy_"+buildings[i].buy_amounts[qty]).disabled = !can_purchase;
							GUI_buy_qty_buttons_buyable[w][i][qty] = can_purchase;
							//console.log("updated!");
						}
						
						if (gui_formatting_changed || GUI_buildings_unlocked[w][i] != building_unlocked) {
							get_element(buildings[i].name+"_buy_"+buildings[i].buy_amounts[qty]).innerHTML = "buy " + beautify(buildings[i].buy_amounts[qty]) + (buildings[i].buy_amounts[qty]<money_display_threshold?"x":"");
						}
					}
				}
				
			} else {
				let can_purchase = currency.get_amount().gte(buildings[i].get_price());
				if (gui_update_prices) get_element(buildings[i].name+"_invest_button_price").innerHTML = " " + money(buildings[i].get_price(), currency.symbol);
				get_element(buildings[i].name+"_invest_button_price").className = can_purchase ? "price-canafford noselect" : "price-cantafford noselect";
				get_element(buildings[i].name+"_invest_button").className = can_purchase ? "button noselect button-enabled" : "button noselect button-disabled";
				get_element(buildings[i].name+"_invest_button").disabled = !can_purchase;
				
				if (currency.get_total().lt(buildings[i].get_price().div(2))) {
					get_element(buildings[i].name).hidden = true;
				} else {
					get_element(buildings[i].name).hidden = false;
				}
			}
			
			//buildings[i].profit_multiplier = Decimal(1); // this needs to be reset each frame so that upgrade actions do not compound.
			//buildings[i].speed_multiplier = Decimal(1); // same tbh
			// however, you can't reset them before the profit and time indicators are drawn! (that's why they're down here in an awkward place)
			
			if (gui_update_prices) buildings[i].gui_override_update_price = false; // can't forget that!
			if (gui_update_amount_info) { // or this!
				GUI_building_amounts[w][i] = buildings[i].get_amount();
				buildings[i].gui_override_update_amount = false;
			}
			if (GUI_buildings_unlocked[w][i] != building_unlocked) GUI_buildings_unlocked[w][i] = building_unlocked;
		}
		
		//world.currency.tick(); this stuff was moved because its delay was messing with 1st loop building profit calculations
		//world.calculate_claimable_angels();
		//world.calculate_cost_of_next_angel();
		//world.calculate_total_angel_boost();
		if (dollars.get_all_time().gt(10**9)) { // specific gating for the discovery of investors
			get_element("angels").className = "angels";
			if (GUI_displayed_angels == world.id) { // otherwise you get the wacky conflicts hehe tehe
				let angel_name = world.angel_investors.display_name;
				let pluralize = world.claimable_angels.valueOf() != "1";
				// ugh so much setup required just to display the cost of the next angel.
				let show_cost_of_next_angel = world.claimable_angels.plus(world.angel_investors.get_total()).lte(1000000); // this is to avoid the inaccuracies caused by calculating the next angel for when money amounts get into the septendecillions (this was/is a cookie clicker bug, infact!)
				if (show_cost_of_next_angel != GUI_show_cost_of_next_angel) {
					GUI_show_cost_of_next_angel = show_cost_of_next_angel; // i love this solution
					if (!GUI_show_cost_of_next_angel) {
						get_element("cost_of_next_angel").className = "hidden";
					} else {
						get_element("cost_of_next_angel").className = "";
					}
				}
				
				if (show_cost_of_next_angel) {
					let till_next = world.cost_of_next_angel.minus(world.currency.get_all_time());
					let should_display = till_next.gte(0); // grrrr weird cuberoot shenanigans (this also happens in cookie clicker)
					
					get_element("cost_of_next_angel").innerHTML = "You need " + (should_display ? money(world.cost_of_next_angel - world.currency.get_all_time(), world.currency.symbol) : world.currency.symbol + "(some amount)") + " to get to the next "+angel_name+".";
					get_element("cost_of_next_angel").style.color = world.currency_color;
				}
				
				let claimable_angels_as_text = beautify(world.claimable_angels);
				get_element("claimable_angels").innerHTML = "Restarting now would give you: " + claimable_angels_as_text + " " + angel_name+(pluralize?"s":"") + ".";
				get_element("claimable_angels").style.color = world.currency_color;
				
				pluralize = world.angel_investors.get_amount().valueOf() != "1";
				get_element("angel_amount").innerHTML = beautify(world.angel_investors.get_amount()) + " " + angel_name + (pluralize?"s":"");
				get_element("boost_per_angel").innerHTML = beautify(world.boost_per_angel.times(100)) + "%";
				get_element("total_angel_boost").innerHTML = "x" + money(world.total_angel_boost, "");
				
				pluralize = world.claimable_angels.valueOf() != "1";
				let can_restart = world.claimable_angels.gt(0);
				let angel_restart_button = get_element("angel_restart_button");
				angel_restart_button.innerHTML = "Restart for "+claimable_angels_as_text+" "+angel_name+(pluralize?"s":"");
				angel_restart_button.disabled = !can_restart;
				angel_restart_button.className = can_restart ? "button noselect button-enabled" : "button noselect button-disabled";
			}
		} else {get_element("angels").className = "hidden";} // also again more display shenanigans
		
		let world_unlock_button = get_element(world.name+"_unlock_button");
		world_unlock_button.innerHTML = world.requirement_text();
		let requirements_met = world.requirement_met(); // are the requirement criteria for getting to this world met yet? ugh this project is rife with bad function names. (<-- fix this!)
		world_unlock_button.disabled = !requirements_met;
		world_unlock_button.className = requirements_met ? "button noselect button-enabled" : "button noselect button-disabled";
		if (!world.requirement_discovery() || world.unlocked) get_element(world.name+"_unlock_button").className += " hidden"; // have we met the requirements for the discovery of this world? if not, add "hidden" to the list of css classes. also, if we've unlocked the world already, then we don't need this button.
		
		if (world.id == GUI_displayed_currency) {
			get_element(currency.name).innerHTML = money(currency.get_amount(), currency.symbol);
			get_element(currency.name).className = "world-currency" + (world.unlocked ? " " : " hidden");
			GUI_currency_box_pos[world.id] /= gui_transition_speed;
		} else {
			GUI_currency_box_pos[world.id] += GUI_currency_box_pos[world.id]<1?1:0;
			GUI_currency_box_pos[world.id] = Math.min(1000, GUI_currency_box_pos[world.id] * gui_transition_speed);
		}
		if (GUI_currency_box_pos[world.id] < 999 && GUI_currency_box_pos[world.id] > 1) get_element(currency.name).style.top = "-"+GUI_currency_box_pos[world.id]+"%";
	}
	if (moon.unlocked != GUI_moon_unlocked) {
		GUI_moon_unlocked = moon.unlocked; // now we know!
		get_element("upgrades_world_selector").className = "button" + (moon.unlocked ? "" : " hidden");
		get_element("angels_world_selector").className = "button" + (moon.unlocked ? "" : " hidden");
		get_element("upgrades_world_selector_label").className = moon.unlocked ? "" : "hidden";
		get_element("angels_world_selector_label").className = moon.unlocked ? "" : "hidden";
	}
	//document.getElementById("dollars").innerHTML = money(dollars.get_amount(), dollars.symbol);
	//document.getElementById("moon_credits").innerHTML = money(moon_credits.get_amount(), moon_credits.symbol);
	
	if (roll) { // pitch yaw
		document.getElementsByTagName("body")[0].style.transform = "rotate("+((cur_loop_time/250)%360)+"deg)";
	}
	
	GUI_displayed_angels = Number(get_element("angels_world_selector").value);
	if (gui_formatting_changed) {GUI_number_formatting = formatting_mode;}
	formatting_mode = Number(get_element("formatting_mode").value);
	past_loop_time = get_time();
	//lemonade_stand.max_time /= 1.01;
	dt = -(cur_loop_time - past_loop_time);
	/* * * frametime stuff * * */ // <-- if there's a slash after the asterisk, the counter will appear. to disable the fps counter, simply remove the slash!
	dts.push(dt);
	if (dts.length > 60) {dts.reverse();dts.pop();dts.reverse()}
	for (let i = 0; i < dts.length; i++) {mft+=dts[i];}
	mft /= dts.length;
	fps = 1000/mft;
	tof += dt;
	nof ++;
	tpf = tof/nof;
	get_element("fps").innerHTML = "lps: "+((fps+'').substr(0,6))+", dt="+dt+", tpf="+(tpf+'').substr(0,6);
	// */
	setTimeout(loop, Math.max(dt,10));
	//window.requestAnimationFrame(loop);// wwawa
}
loop();
//lemonade_stand.base_speed /= 8888888888888
wawa = "";
</script>
</body>
</html>